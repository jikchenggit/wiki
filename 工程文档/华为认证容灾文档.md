---
title: CSSP容灾认证
description: CSSP 容灾认证报告
published: true
date: 2020-07-01T16:14:46.119Z
tags: cssp
editor: markdown
dateCreated: 2020-04-02T07:24:48.804Z
---




数据容灾前必读
==============

本章主要介绍在使用本报告进行数据容灾作为设计指导前，读者需要了解的基本知识、各项要求和注意事项。读者必须仔细阅读本章内容。

[1.1 概述](#概述)

[介绍本文档主要内容及文档中数据容灾基本原理。](#概述)

1.2 [读者要求](#读者要求)

[介绍本报告的适用场景、相关兼容性以及规格限制。](#容灾基本概念)

1.3 [容灾的基本概念](#容灾基本概念)

[介绍对使用本文档进行数据容灾的读者基本技能要求。](#读者要求)

1.4 [注意事项](#术语说明)

[介绍使用本报告进行容灾时必须关注的重要事项。](#术语说明)

1.5 [术语说明](#术语说明)

介绍SuperSync软件容灾中的专用术语。

[1.6 SuperSync软件介绍](#supersync软件介绍)

[介绍SuperSync软件简介及参数含义。](#supersync软件介绍)

1.7 [一致性保证模块介绍](#一致性保证模块介绍)

介绍SuperSync 一致性模块介绍。

1.8 [容灾系统原理简介](#注意事项)

介绍国际通用的容灾系统原理说明。

1.9 [项目建设背景](#_项目建设背景)

介绍此项目大环境下建设的背景情况。

1.10 [项目建设目标](#项目建设目标)

介绍此项目建设后达成的目标。

概述
----

介绍本文档主要内容及文档中数据容灾基本原理。

本文详细描述了利用SuperSync软件实现了不同操作系统平台、存储系统之间和不同数据库的数据容灾，同时提供了常见的问题解答。

本文报告基本原理：

通过SuperSync软件时时同步功能，将源数据库中的数据从主端操作系统平台和主端存储中容灾到备端操作系统平台和目标存储中，容灾切换完成后数据库运行在新的操作系统和存储上，并对外提供应用服务。

本文主要包含如下内容：

数据动态容灾软件介绍——主要描述了通过SuperSync软件进行跨平台的数据库数据容灾。

容灾系统介绍——容灾系统架构。

容灾方案选择——根据现网信息进行评估得出方案结论。

容灾方案的优势——此容灾方案的优势。

容灾系统组建——如何进行容灾系统组件规划和选型。

容灾实施——对于此项目容灾实施的详细计划。

读者要求
--------

介绍对使用本文档进行数据容灾的读者基本技能要求。

本文档用于指导DSG服务工程师和DSG合作工程师使用SuperSync软件实现跨平台和跨存储的数据容灾。操作人员必须具备以下经验和技能：

-   SuperSync软件的操作经验。

-   熟悉当前业务的组网和系统版本信息。

-   AIX和LINUX服务器操作维护经验。

-   Oracle，MySQL，db2数据库操作维护经验。

容灾基本概念
------------

从广义上讲，任何提高系统可用性的努力都可称之为容灾。

主机集群就是一种本地容灾。我们通常说的容灾一般指的是异地远程容灾。远程容灾是指为了防止火灾、水灾、地震、人为破坏等原因带来的区域性灾难而导致系统瘫痪、数据丢失、业务中断，而在原有生产系统之外的另一地点建立备份系统，备份系统具有与原生产系统相同或相似的主机及网络和存储设各。

通常称原生产系统为主中心，备用系统为灾备中心。

系统正常运行时，容灾应用会将数据同时写入主中心和灾备中心的存储设备，并保证二者的一致性。

当主中心发生灾难时，容灾应用能够快速地切换到灾备中心，从而保证数据的完整性和业务的连续性。

当主中心系统恢复后，主中心会向备份中心进行数据重新同步，然后容灾应用切换回主中心。由此可见，容灾是通过在异地建立和维护一个备份系统，利用地理上的分离来保证系统和数据对灾难性事件的抵御能力。

术语说明
--------

1.  **数据库的主备初始化（简称初始化）：**SuperSync软件将现有数据全部一次性传输到目标库；

2.  **数据库的实时数据分析和应用（简称实时数据）：**SuperSync软件实时同步，将redo
    > 和archivelog日志分析后成XF1传输到目标端进行装载应用；

3.  **灾难切换（统称容灾切换）：**主端意外停止，启用备端为生产服务器;

4.  **主备切换（统称容灾切换）：**为了验证容灾有效性，需要周期性测试在灾难切换下，备端能够正常启用为生产服务器；

5.  **主生产端（简称主端）：**生产服务器数据库。

6.  **备生产端（简称备端）：**即将启用的生产服务器数据库。

SuperSync软件介绍
-----------------

1.  介绍 SuperSync 软件实现原理

图 2.7 展示了redo log
的逻辑备份原理，这种方式是使用数据库以外的独立进程，捕捉 redo log file
的信息，将其翻译成事务语句，再通过网络传输到目标端数据库，在目标端数据库执行同样的事务。如果其进程赶不上数据库日志切换，也

可以捕捉归档日志中的内容。也有的产品在源端以事务为单位，当一个事务完成后，再把它传输到目标端。

> <img src="media/image3.png" style="width:3.33542in;height:2.38403in" />
>
> <img src="media/image5.png" style="width:0.98472in;height:0.89653in" /><img src="media/image9.png" style="width:0.98472in;height:0.89653in" />图
> 2.5 基于redo log 的逻辑容灾原理

这种策略由于容灾的是事务容灾：事务容灾将数据的初始快照传播到订阅服务器，然后，当发布服务器（主节点）上发生数据修改时，捕获个别的更新事务并传播到订阅服务器

（副节点）。该方法控制灵活，资源消耗较少，只针对提交的更新事务进行容灾控制。在容灾过程中，源数据库和目的数据库只需要封锁与需要容灾的更新事务有冲突的数据对象，执行效率较高。同时通过标准的事务控制接口可以对多数异构数据库进行容灾控制，适应性较强。

1.  SuperSync原理简介。

    <img src="media/image13.png" style="width:5.17483in;height:3.13797in" />

**原理总揽：**

SuperSync是通过对生产数据库上的log日志进行分析，并转换为交易指令xf1（可理解为SQL语句），将交易指令发送到容灾端，由容灾端的ORACLE数据库重新执行这些交易指令的方式来保持生产数据库和容灾数据库的数据一致性。

**分析：**

SuperSync通过安装在源端的日志分析模块(ologx)对redo
log进行实时分析（当redolog被覆盖后，ologx自动寻找archive
log），分析结果生成xf1文件，存入本地的缓存队列(queue);然后有生产数据库上的发送进程sender从queue中读取最新产生的交易指令发送到容灾数据库上的接收进程（receiver).

**装载：**

容灾端的接收进程将受到的交易指令存入容灾端的缓存队列（queue）中，再由容灾端的装载进程（loader)通过ORACLE提供的OCI函数装入到数据库中。

在使用SuperSync软件时，应该注意以下几点：

-   xexp和ximp是独立软件，它们既可以进行灵活的修复导出和倒入适用于源端和目标端。

-   SuperSync软件启用后会占用内存，一套SuperSync软件会占用1g
    内存，1%的CPU使用率。

-   需要单独的磁盘空间来安装软件和缓存数据库时时数据。

-   在这同步执行过程中，老生产系统的业务可以保持运行状态。无需中断业务。

1.  SuperSync软件的数据传输机制。

SuperSync软件有在数据库之间移动数据的机制，只有一种网络连接同步。

网络连接同步，是最快的方式不需要落地装载。

一致性保证模块介绍
------------------

SuperSync 软件可以采用添加软件模块的方式保证数据的一致性。

而xcmp 就是SuperSync 的一个数据一致性保证模块。请见图1：

**图1 模块的架构原理图：**

<img src="media/image14.jpeg" style="width:5.13746in;height:1.33566in" />

使用XCMP 原理说明：

\(1\) 抽取两边数据进行CRC 校验码生成。

\(2\) 进行CRC 比对是否一致，不一致则提取出ROWID.进行精准修复。

注意事项
--------

描述使用本报告进行容灾切换时必须关注的重要事项。

在容灾切换过程中，务必关注以下注意事项：

1.  SuperSync逻辑容灾容灾主备初始化不需要停业务进行容灾，主备切换测试请注意申请合适的业务窗口。

2.  数据容灾切换会对相关联的业务造成一定影响，请注意在相关联业务的空闲阶段做数据容灾切换操作。

3.  主库与备库的字符集和国家字符集必须相同。

4.  SuperSync逻辑容灾支持在物理或逻辑的Standby数据库上使用.

5.  SuperSync逻辑容灾将不会加载唯一索引被禁用的表，如果需要将数据加载到表中，需要将索引移除或重新启用。

6.  SYS用户空间下的触发器不会被处理，这需要在备端数据库执行完导入后，手动重新创建SYS用户空间下的触发器。

7.  注意DBLINK需要重新创建这些对象。

8.  如果导出数据被一个realm保护的，必须有这个realm的授权才能导出。

9.  以下场景为SuperSync 不能同步数据。

-   集群中的表。

-   已存在表的插入模式下启用了访问控制。

-   表中包含XML列或ANYTYPE,中文字段类型的列。

-   表中有加密的列。

-   加密表空间。

1.  如下同步场景，SuperSync不会自动创建表空间表空间必须在导入的数据库上已经存在。并调整好相同大小。

2.  容灾时，要求按照表和Schema类型进行划分。

3.  其他注意事项不一一列出，若有疑问请联系迪思杰专业团队。

容灾系统原理简介
----------------

容灾系统实施异地多点容灾的目的是为了抵御如火灾、水灾、军事打击等区域性灾难事件的袭击以及来自网络内部的由于软件缺陷造成的网络攻击，保证数据库系统关键业务的
7×24
连续性，从而支持整个系统的应用级容灾。要求将现有数据处理中心作为容灾系统的容灾节点，重复建设数据处理中心将造成资源浪费，而现有数据处理中心可能已经使用了不同的数据库系统，因此要求容灾系统能够支持异构性。关键业务对数据的完整性和一致性有很高的要求，要求各容灾节点保持数据一致性。

根据上述总体要求，容灾系统必须采用异地的异构的容灾方式，容灾系统应该实现如下功能和特性：

1.  容灾系统正常运行时，要能够给关键业务提供高可靠的一致性数据。当部分容灾节点发生灾难时，整体业务不受灾难影响仍然能正常运行。

2.  发生灾难的节点在系统修复好后，系统要能够将数据从正常的节点恢复到该节点数据库中，并要求恢复的数据与源数据保持一致。

    -   **图1.2 一致性保证原理图：**

<span id="_项目建设背景"
class="anchor"></span><img src="media/image15.png" style="width:5.99798in;height:2.77778in" />

 项目建设背景
------------

在“金税三期”项目实施上线后，随着系统的增多和数据量的增加，保障信息系统和数据安全尤显重要。某省地区地震频发，各类基础设施相对落后，同时交通不便。一旦遭遇自然灾害或者设备
故障，所有“金税三期”的建设成果将毁于一旦。

建设异地灾备系统是解决上述问题的唯一途径。本次某省国税局通过招标，为金三核心征管系统、个税系统、防伪税控系统、货运系统、综合办公系统建设异地应用级灾备系统；为电子底账、电子发票、出口退税、财务/人事、税收执法系统等建设异地数据级灾备系统。

本项目由北京xxxx科技有限公司承建，采用迪思杰(北京)数据管理技术有限公司的跨平台异地容灾解决方案实现。

项目建设目标
------------

通过异地灾备系统建设，在预定的工程实施期内，实现核心征管等5套业务系统的异地应用级灾备功能(同步数据和应用)，电子底账等5套业务系统的数据级灾备功能(仅同步数据)。在某省国税整体网络和安全系统完好的情况下，发生诸如存储、服务器等故障时，通过灾备系统能保证税收业务数据的完整性，并能够在短时间内接管业务，支持基本的税务业务处理(确保纳税人可以通过办税大厅完成缴税任务)，保障业务连续性。

本项目设定的灾备技术指标是数据延迟(RPO)为秒级，系统切换时间不超过2小时。

现网信息和方案选择
==================

介绍数据容灾前需要对收集的现网信息进行确认，列出主要的环境信息

对于现网信息进行分析处理。得出最优方案

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

实际现网中可能需要收集更多信息，请根据现网情况扩充信息收集范围。

2.1 [环境信息总览](#环境信息总览)

对现网进行调研，收集需要容灾的信息。

[2.2 主机性能信息](#主机性能信息)

[介绍对于现网信息性能信息进行收集和分析。](#主机性能信息)

2.3 [此次容灾特点和方案筛选](#_此次容灾特点和方案筛选)

介绍方案选择是否支持此场景。

2.4 [容灾方案选择](#容灾方案选择)

介绍工作库方案选择依据。

环境信息总览
------------

> 此章节为此次某省国税容灾方案环境信息.

**表2-1 核心业务系统数据库信息**

| 序号 | 系统名称   | 操作系统 | 数据库版本               | 数据量 | 字符集                     | IP地址        |
|------|------------|----------|--------------------------|--------|----------------------------|---------------|
| 1    | 核心征管1  | AIX 7.1  | Oracle11.2.0.3.0-64bit   | 1080GB | AL32UTF8                   | 97.12.96.100  |
|      |            |          |                          |        |                            | 97.12.96.102  |
| 2    | 核心征管2  | AIX 7.1  | Oracle11.2.0.3.0 - 64bit | 318GB  | AL32UTF8                   | 97.12.96.105  |
|      |            |          |                          |        |                            | 97.12.96.107  |
| 3    | 核心征管3  | AIX 7.1  | Oracle11.2.0.3.0 - 64bit | 1267GB | AL32UTF8                   | 97.12.96.95   |
|      |            |          |                          |        |                            | 97.12.96.97   |
| 4    | 个税核心库 | AIX 7.1  | Oracle11.2.0.3.0 - 64bit | 80GB   | SIMPLIFIED CHINESE\_CHINA  | 97.12.96.110  |
|      |            |          |                          |        | .AL32UTF8                  | 97.12.96.112  |
| 5    | 个税查询库 | AIX 7.1  | Oracle11.2.0.3.0 - 64bit | 110GB  | SIMPLIFIED CHINESE\_CHINA  | 97.12.96.101  |
|      |            |          |                          |        | .AL32UTF8                  | 97.12.96.103  |
| 6    | 个税集成库 | AIX 7.1  | Oracle11.2.0.3.0 - 64bit | 223GB  | SIMPLIFIED CHINESE\_CHINA  | 97.12.96.106  |
|      |            |          |                          |        | .AL32UTF8                  | 97.12.96.108  |
| 7    | 防伪税控   | AIX 5.3  | Oracle 9.2.0.8           | 34GB   | AMERICAN\_AMERICA          | 97.12.96.13   |
|      |            |          |                          |        | .US7ASCII                  | 97.12.96.15   |
| 8    | 货运系统   | AIX 5.3  | Oracle 9.2.0.8           | 28GB   | SIMPLIFIED CHINESE\_CHINA. | 97.12.96.21   |
|      |            |          |                          |        | ZHS16GBK                   | 97.12.96.23   |
| 9    | 综合办公   | AIX 5.3  | Oracle 9.2.0.8           | 154GB  | SIMPLIFIED CHINESE\_CHINA  | 97.12.96.45   |
|      |            |          |                          |        | .ZHS16GBK                  | 97.12.96.47   |
| 10   | 电子底账   | AIX6.1   | Oracle 11.2.0.4          | 153GB  | SIMPLIFIED CHINESE\_CHINA  | 97.12.96.67   |
|      |            |          |                          |        | .ZHS16GBK                  | 97.12.96.69   |
| 11   | 电子发票   | AIX6.1   | Oracle 11g               | 11GB   | SIMPLIFIED CHINESE\_CHINA  | 97.12.96.53   |
|      |            |          |                          |        | .ZHS16GBK                  | 97.12.96.86   |
| 12   | 出口退税   | Wind008E | Oracle11.2.0.4           | 30GB   | SIMPLIFIED CHINESE\_CHINA  | 97.12.100.160 |
|      |            |          |                          |        | .ZHS16GBK                  |               |
| 13   | 财务系统   | AIX 5.3  | Oracle 9.2.0.8           | 130GB  | AMERICN\_CHINA.            | 97.12.96.51   |
|      |            |          |                          |        | ZHS16GBK                   |               |
| 14   | 人事系统   | AIX 5.3  | Oracle9i                 | 98MB   | AMERICAN\_CHINA.           | 97.12.96.51   |
|      |            |          |                          |        | ZHS16GBK                   |               |

**表2-2 “金三”核心业务系统应用信息**

| **序号** | **安全域** | **应用系统** | **子系统**            | **CPU/内存** | **操作系统**                 | **负责厂商** |
|----------|------------|--------------|-----------------------|--------------|------------------------------|--------------|
| **1**    | 安全支持域 | 安全策略二包 | 单点登录和权限        | 8核/64GB     | Oracle Linux 6.3-64bit       | 总参         |
| **2**    |            |              | LDAP1                 | 8核/32GB     | Oracle Linux 6.3-64bit       |              |
| **3**    |            |              | LDAP2                 | 32核/32GB    | CA业务专网发布服务器（I3）   |              |
| **4**    | 业务处理域 | 核心征管     | 征管核心定时任务      | 12核/96GB    | Oracle Linux 6.3-64bit       | 中软         |
| **5**    |            |              | 通用查询集成平台      | 12核/96GB    | Oracle Linux 6.3-64bit       |              |
| **6**    |            |              | 工作流门户应用        | 12核/96GB    | Oracle Linux 6.3-64bit       |              |
|          |            |              | 集成平台管理          |              |                              |              |
| **7**    |            | 管理决策一包 | 会计核算              | 8核/64GB     | Oracle Linux 6.3-64bit       | 神码         |
| **8**    |            | 个税管理     | 个税核心处理          | 8核/64GB     | Oracle Linux 6.3-64bit       | 税友         |
|          |            |              | 定时任务              |              |                              |              |
| **9**    |            | 税库银       | 税库银应用            | 8核/64GB     | Oracle Linux 6.3-64bit       | 神码         |
| **10**   |            |              | 税库银监控应用        | 4核/32GB     | Red hat Linux 6.2            |              |
| **11**   | 前置支持域 | 核心征管     | 集成平台（渠道）      | 8核/64GB     | Oracle Linux 6.3-64bit       | 中软         |
| **12**   |            |              | 层级交换MQ            | 8核/64GB     | Oracle Linux 6.3-64bit       |              |
| **13**   | 业务服务域 | 核心征管     | 征管前端应用          | 8核/64GB     | Oracle Linux 6.3-64bit       | 中软         |
| **14**   |            |              | 工作门户              | 8核/64GB     | Oracle Linux 6.3-64bit       |              |
|          |            |              | BS设计                |              |                              |              |
| **15**   |            | 库税银       | MQ                    | 2核/8GB      | windows 2003 x32             | 神码         |
| **16**   |            | 核心征管     | 版本发布机            | 2核/8GB      | Windows Server 2008 （64位） | 中软         |
| **17**   |            |              | 版本发布机（测试DNS） | 2核/8GB      | Windows Server 2008 （64位） |              |
| **18**   |            |              | 个税大厅系统          | 8核/64GB     | Oracle Linux 6.3-64bit       |              |
| **19**   |            |              | 个税监控应用          | 8核/64GB     | Oracle Linux 6.3-64bit       |              |
| **20**   |            | DNS          | 生产主DNS             | 8核/8GB      | 红旗Asianux Server 3         | 局方         |
| **21**   |            |              | 生产备DNS             | 8核/8GB      | 红旗Asianux Server 3         |              |

> **表2-3 其他业务应用服务器信息**

| **序号** | **应用系统名称** | **子系统名称** | **CPU/内存** | **操作系统**     | **负责厂商** |
|----------|------------------|----------------|--------------|------------------|--------------|
| **1**    | 防伪税控         | 防伪税控       | 　           | Windows 2003 X32 | 航信         |
| **2**    | 货运系统         | 货运系统       | 　           | Windows 2003 X32 | 总参         |
| **3**    | 综合办公         | 综合办公       | 　           | Windows 2003 X32 | 中软         |

> ----结束

主机性能信息
------------

介绍数据容灾前需要确认的主机信息和收集方法。

**表2-4 核心业务系统性能信息**

| **序号** | **系统名称** | **磁盘i/o**         | **网络**     | **磁盘io**            | **cpu/内存**         |
|----------|--------------|---------------------|--------------|-----------------------|----------------------|
| 1        | 核心征管1    | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 2        | 核心征管2    | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 3        | 核心征管3    | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 4        | 个税核心库   | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 5        | 个税查询库   | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 6        | 个税集成库   | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 7        | 防伪税控     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 8        | 货运系统     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 9        | 综合办公     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 10       | 电子底账     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 11       | 电子发票     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 12       | 出口退税     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 13       | 财务系统     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |
| 14       | 人事系统     | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈，请见信息总览. | 无瓶颈，请见信息总览 |
|          |              |                     |              |                       |                      |

**表2-5 “金三”核心业务系统性能信息**

| **序号** | **安全域** | **应用系统** | **子系统**            | **磁盘i/o**         | **网络**     | **cpu/内存**        |
|----------|------------|--------------|-----------------------|---------------------|--------------|---------------------|
| **1**    | 安全支持域 | 安全策略二包 | 单点登录和权限        | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **2**    |            |              | LDAP1                 | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **3**    |            |              | LDAP2                 | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **4**    | 业务处理域 | 核心征管     | 征管核心定时任务      | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **5**    |            |              | 通用查询集成平台      | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **6**    |            |              | 工作流门户应用        | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
|          |            |              | 集成平台管理          |                     | 20MB(不稳定) |                     |
| **7**    |            | 管理决策一包 | 会计核算              | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **8**    |            | 个税管理     | 个税核心处理          | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
|          |            |              | 定时任务              |                     |              |                     |
| **9**    |            | 税库银       | 税库银应用            | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **10**   |            |              | 税库银监控应用        | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **11**   | 前置支持域 | 核心征管     | 集成平台（渠道）      | 20MB(不稳定)        | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **12**   |            |              | 层级交换MQ            | 无瓶颈（空闲为80%） |              | 无瓶颈（空闲为80%） |
| **13**   | 业务服务域 | 核心征管     | 征管前端应用          | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **14**   |            |              | 工作门户              | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
|          |            |              | BS设计                |                     |              |                     |
| **15**   |            | 库税银       | MQ                    | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **16**   |            | 核心征管     | 版本发布机            | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **17**   |            |              | 版本发布机（测试DNS） | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **18**   |            |              | 个税大厅系统          | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **19**   |            |              | 个税监控应用          | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **20**   |            | DNS          | 生产主DNS             | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |
| **21**   |            |              | 生产备DNS             | 无瓶颈（空闲为80%） | 20MB(不稳定) | 无瓶颈（空闲为80%） |

> **表2-6 其他业务应用性能信息**

| **序号** | **应用系统名称** | **子系统名称** | **CPU/内存** | 网络         |
|----------|------------------|----------------|--------------|--------------|
| **1**    | 防伪税控         | 防伪税控       | 无压力       | 20MB(不稳定) |
| **2**    | 货运系统         | 货运系统       | 无压力       | 20MB(不稳定) |
| **3**    | 综合办公         | 综合办公       | 无压力       | 20MB(不稳定) |

### 性能现状总结

根据以上性能信息和环境信息得出资源瓶颈在于网络带宽。

此次容灾特点和方案筛选
----------------------

从以上现有数据量和业务性质来看，本次任务具有以下特点：

根据特点选择测试方案：

1、**应用数量多大**

需要容灾到X86平台的Oracle数据库的总套数为48套。

2**、跨操作系统、跨数据库版本**

此次容灾需要将从现有的平台上的Oracle 10G,Oracle 9i
等数据库，容灾到Oracle11g等异构数据库。

3**、切换时间有限**

由于数据库是核心业务系统，正常工作时间为周一至周五。所以容灾切换要求时间非常少。

4**、数据准确性要求高**

由于本次容灾的数据都是核心生产数据。如果出现数据准确性问题，将导致管理系统运行的紊乱，引起社会的投诉，因此容灾后的数据不允许有任何问题。鉴于此，本次容灾工作具有“跨版本，大数据量，停机时间短，数据准确性要求高”的特点。

**5、网络性能受限**

由于数据容灾网络速率较小。所有“性能受限的”的特点。

容灾方案选择
------------

| **方式**         | **方法**                       | **容灾切换时间** | **是否受限于资源**                 | **跨数据库版本** | **跨操作系统架构** | **准确性高** | **大数据量** | **方案可行性** |
|------------------|--------------------------------|------------------|------------------------------------|------------------|--------------------|--------------|--------------|----------------|
| expdp            | 增量，静态方式按照增量拉取数据 | 支持             | 受限于数据库bug                    | 不支持           | 支持               | 是           | 是           | 否             |
| rman备份         | 增备方式                       | 支持             | 受限于磁盘IO 和数据量过大          | 不支持           | 支持               | 是           | 是           | 否             |
| datagurd         | 不支持                         | \*               | \*                                 | 不支持           | 不支持             | 是           | 是           | 否             |
| supersync        | 增量，静态方式按照增量拉取数据 | 支持             | 可调控资源消耗，在低带宽的情况下。 | 支持             | 支持               | 是           | 是           | 可行           |
| exp              | 增量，静态方式按照增量拉取数据 | 支持             | 受限制为网络                       | 不支持           | 支持               | 是           | 是           | 可行           |
| 物理镜像         | 当天晚上静态copy               | 不支持           | 受限于网络                         | 不支持           | 不支持             | 是           | 是           | 否             |
| 物理数据文件copy | 当天晚上静态copy               | 不支持           | 受限于网络                         | 不支持           | 不支持             | 是           | 是           | 否             |
| 传输表空间       | 10G 不支持增量备份             | 不支持           | 不受限                             | 不支持           | 支持               | 是           | 是           | 否             |

### 方案筛选结论

以上结论得出网络带宽不足、跨版本、跨平台得出：

-   只能使用supersync 方式容灾.

 容灾方案的优势
==============

本章主要介绍SuperSnyc容灾时的优势。

3.1 [效率高、速度快](#效率高速度快)

3.2[无中断的数据容灾](#无中断的数据容灾)

3.3 [跨数据库平台的容灾](#跨数据库平台的容灾)

3.4 [跨OS系统平台的容灾](#跨os系统平台的容灾)

> 在现实的容灾实践中，该容灾方案在实施过程中，展现了非常独特的优势，如下：

效率高、速度快
--------------

与其它同类容灾技术相比，在效率上和性能上都远远高于其它同类解决方案。例如，在某省电信采用该容灾方式在2个多小时完成了1.9TB数据的容灾工作。

无中断的数据容灾
----------------

如果采用该容灾工具首次容灾方式，不需要对原系统业务进行限制、甚至停止原系统，从而减少在长时间容灾过程中对原系统的影响。

跨数据库平台的容灾
------------------

可支持Oracle任意两个不同版本之间的数据容灾，例如：支持从Oracle 7.3.4 到
Oracle 8.1.7或Oracle
9i、oracle10g、oracle11g、oracle12c等更多异构数据库版本。

跨OS系统平台的容灾
------------------

可支持运行在不同操作系统平台上的两个Oracle系统之间的容灾，例如：在AIX、HP
UX、LINUX、WINDOW之间的容灾等。

容灾系统组建
============

介绍配置备端数据库的方法。

在进行数据容灾之前，应提前完成灾备系统配置。

3.1 [灾备建设具体要求](#容灾建设具体要求)

[介绍数据容灾前需要准备的指导原则。](#_ZH-CN_TOPIC_0025290650)

3.2 [灾备环境设备规划](#容灾环境设备规划)

[介绍数据容灾前灾备环境的设备规划。](#_ZH-CN_TOPIC_0025290646)

3.3 [容灾网络及其他设施](#容灾网络及其他设施)

介绍搭建容灾网络架构和其他设设施规划。

容灾建设具体要求
----------------

在某省国税局数据中心机房基础设施、网络系统、安全系统等正常运转的前提下，当核心业务系统的主机、数据库或中间件出现重大故障，在短时间内无法恢复系统正常运转，直接影响前台业务受理的情况下，为各级税务机关提供核心业务系统的大厅受理方式（不包括所有网上业务受理）的应用级灾备；同时为其他较重要业务系统提供数据级灾备。

本方案中共10个应用节点。其中5个为应用级，包括金三核心征管系统、个税系统、防伪税控系统、货运系统、综合办公系统。5个为数据级，包括电子底账、电子发票、出口退税、财务/人事、税收执法系统。具体内容在实施时可根据实际情况进行调整。在平时，灾备系统可以承担查询、统计、分析、数据抽取等业务功能，分担金三业务系统压力。

容灾环境设备规划
----------------

本项目中xx灾备机房建成后配置的设备主要包括：

1）4台8路 浪潮高端PC服务器，每台可分为2个物理分区；

2）6台2路 浪潮PC服务器；

3）3台路由器

4）1台EMC磁盘阵列

相关设备的配置及详细信息见下列表：

**表3-4 灾备中心主要设备配置信息**

| **序号** | **设备名称** | **设备型号**    | **设备配置**                       | **设备数量** | **备注** |
|----------|--------------|-----------------|------------------------------------|--------------|----------|
| **1**    | 数据库服务器 | 浪潮TS860G3     | 8颗16核CPU，512GB内存，4个千兆网卡 | 4台          | 　       |
| **2**    | 应用服务器   | 浪潮NF5280M4    | 2颗6核CPU，64GB内存，2个千兆网卡   | 6台          | 　       |
| **3**    | 路由器       | 锐捷RSR7708-X   | 　                                 | 3台          | 　       |
| **4**    | 磁盘阵列     | EMC SYM DS6510B | 容量70TB                           | 1台          | 　       |
| **5**    | 灾备软件     | DSG SuperSync   | 　                                 | 10套         | 　       |

**表3-5 灾备中心数据库服务器分区信息**

| 序号  | 设备型号    | 分区配置              | IP地址      | 操作系统          |
|-------|-------------|-----------------------|-------------|-------------------|
| **1** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.1 | Red Hat Linux 6.4 |
| **2** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.2 | Red Hat Linux 6.4 |
| **3** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.3 | Red Hat Linux 6.4 |
| **4** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.4 | Red Hat Linux 6.4 |
| **5** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.5 | Red Hat Linux 6.4 |
| **6** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.6 | Red Hat Linux 6.4 |
| **7** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.7 | Red Hat Linux 6.4 |
| **8** | 浪潮TS860G3 | 4颗16核CPU，256GB内存 | 97.12.190.8 | Red Hat Linux 6.4 |

**表3-6 灾备中心应用服务器虚拟化信息**

| 序号   | 设备型号     | 虚拟机名称      | 初始配置 | IP地址       | 操作系统               |
|--------|--------------|-----------------|----------|--------------|------------------------|
| **1**  | 浪潮NF5280M4 | vm\_zb\_dddl    | 4核8GB   | 97.12.190.40 | Oracle Linux 6.3-64bit |
| **2**  | 浪潮NF5280M4 | vm\_zb\_kjhs    | 2核8GB   | 97.12.190.41 | Oracle Linux 6.3-64bit |
| **3**  | 浪潮NF5280M4 | vm\_zb\_hxzgds  | 2核16GB  | 97.12.190.42 | Oracle Linux 6.3-64bit |
| **4**  | 浪潮NF5280M4 | vm\_zb\_gshxds  | 4核32GB  | 97.12.190.43 | Oracle Linux 6.3-64bit |
| **5**  | 浪潮NF5280M4 | vm\_zb\_hxzgcx  | 6核32GB  | 97.12.190.44 | Oracle Linux 6.3-64bit |
| **6**  | 浪潮NF5280M4 | vm\_zb\_hxzgjcn | 6核32GB  | 97.12.190.45 | Oracle Linux 6.3-64bit |
| **7**  | 浪潮NF5280M4 | vm\_zb\_ksyyy   | 2核16GB  | 97.12.190.46 | Oracle Linux 6.3-64bit |
| **8**  | 浪潮NF5280M4 | vm\_zb\_ksyjk   | 2核16GB  | 97.12.190.47 | Red Hat Linux 6.3      |
| **9**  | 浪潮NF5280M4 | vm\_zb\_hxzgjcq | 4核16GB  | 97.12.190.48 | Oracle Linux 6.3-64bit |
| **10** | 浪潮NF5280M4 | vm\_zb\_hxzgmq  | 4核16GB  | 97.12.190.49 | Oracle Linux 6.3-64bit |
| **11** | 浪潮NF5280M4 | vm\_zb\_hxzgqd  | 6核32GB  | 97.12.190.50 | Oracle Linux 6.3-64bit |
| **12** | 浪潮NF5280M4 | vm\_zb\_hxzgmh  | 6核32GB  | 97.12.190.51 | Oracle Linux 6.3-64bit |
| **13** | 浪潮NF5280M4 | vm\_zb\_ksymq   | 2核8GB   | 97.12.190.52 | Win2003 32bit          |
| **14** | 浪潮NF5280M4 | vm\_zb\_gsdt    | 2核16GB  | 97.12.190.53 | Oracle Linux 6.3-64bit |
| **15** | 浪潮NF5280M4 | vm\_zb\_gsjk    | 2核16GB  | 97.12.190.54 | Oracle Linux 6.3-64bit |
| **16** | 浪潮NF5280M4 | vm\_zb\_fwsk    | 6核24GB  | 97.12.190.55 | Win2003 32bit          |
| **17** | 浪潮NF5280M4 | vm\_zb\_hyxt    | 4核16GB  | 97.12.190.56 | Win2003 32bit          |
| **18** | 浪潮NF5280M4 | vm\_zb\_zhbg    | 4核32GB  | 97.12.190.57 | Win2003 32bit          |
| **19** | 浪潮NF5280M4 | vm\_zb\_DNS     | 4核8GB   | 97.12.190.58 | 红旗Asianux Server3    |

容灾网络及其他设施
------------------

当前此项目中心机房和此项目灾备机房之间的网络连接为20MB，为了初始化数据同步需要，可以临时升级到50MB带宽。

目前此项目中心机房配置了2台F5负载均衡系统。

**图4-1 灾备系统结构示意图**

如上图所示，整个灾备系统的结构分为如下几个部分:

1.  灾备基础设施。

> 本项目中选择某某省税务局机房作为异地灾备机房，距离相距约450公里，两个机房之间采用税务专网连接，网络带宽约为20M。灾备基础设施的建设包括灾备机房、网络、电力、安全防护等。

2）灾备系统物理结构。

为了实现应用级灾备，在异地灾备中心需要配置主机、存储、SAN交换机、网络交换机等基本物理设备。其中，4台浪潮高端PC服务器
作为金三核心征管、个税、防伪税控、货运系统及其他5套业务系统的数据库容灾服务器；
6台浪潮X86服务器作为金三核心征管、个税、防伪税控、货运系统等业务系统的应用灾备服务器，

每台数据库服务器划分为2个分区；每台X86服务器通过虚拟化软件部署3台虚拟机，作为应用灾备服务器。

3）灾备容灾结构。采用DSG
SuperSync灾备软件实现10套业务数据库的1:1实时容灾。其中5套业务应用及非结构化数据容灾使用DSync实现应用级灾备。

4）灾备应急体系。在完成灾备系统建设后，通过灾备演练和制度建设，实现异地灾备系统的应急处置体系，提高应对突发灾难/故障的
处置能力。

数据容灾实施
============

本章主要介绍数据容灾总体流程，包括数据容灾中的各项步骤及其责任分工。本章还描述了容灾过程中的环境组网，以供方案使用者参考。

5.1 [容灾切换场景](#容灾切换场景)

介绍容灾切换的主要场景。

5.2 [数据容灾和容灾切换总体实施](#数据容灾实施和容灾切换总体)

[介绍使用本方案进行数据容灾的完整流程。](#数据容灾实施和容灾切换总体)

5.3 [确定分工界面](#确定分工界面)

介绍[数据容灾项目实施过程中的责任分工。](#容灾组网图描述)

5.4 [数据库性能测试](#数据库性能测试)

介绍数据库性能测试。

5.5 [容灾组网图描述](#容灾组网图描述)

[介绍容灾前、容灾中和容灾后的容灾组网图。](#容灾组网图描述)

容灾切换场景
------------

介绍需要执行业务容灾切换的场景。

考虑容灾切换的时间。发生如下情况未能解决则需要容灾切换操作。

-   主端设备发生短时间无法处理的硬件故障；

-   主端系统无法正确识别分配的存储空间；

-   主端业务经过重新配置后无法正常运行，而且没有相关解决报告；

-   主端关键数据误操作，且在计划的8个小时之内不能解决；

-   主端数据正确，没有发现数据丢失，但是业务办理不成功；

-   主端在数据正确，但是业务性能显著下降；

-   主端数据库异常，影响业务且短时间无法解决；、

-   日常主备切换演练。

-   以上情况将进行数据库容灾的切换

数据容灾实施和容灾切换总体
--------------------------

介绍使用本文档进行数据容灾的完整流程和大体流程。

### 实施阶段划分

本次项目实施的阶段划分如下：

1.  安装配置阶段

在该阶段主要进行环境调查，方案讨论，系统软硬件配置，安排实施工期，安排实施人员、容灾软件安装配置、DB
环境准备、在系统上调试并使系统可以进行数据复制。

1.  测试准备阶段

在该阶段。

筛选用户和排除废弃用户、废弃表、临时表。

1.  数据复制阶段

测试完成后，按照最终确定的复制策略对数据进行复制，实现数据从旧数据中心到新数据中心的复制。

1.  容灾切换后系统试运行阶段

在容灾切换后，备端系统上线运行时，对系统进行跟踪观察和优化，使其性能更优，操作更加简单方便。

1.  评估总结阶段

对实施效果进行评估，整理文档，提交相关文档与报告。

1.  现场培训阶段：

主要包括对所有5套业务系统的应用进行部署和测试验证；

1.  演练验收阶段：

对灾备系统进行灾备演练，对建设成果进行评价和验收。

### 实施进度计划

本次项目实施整体进度与分工计划如下表:

> <img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />
>
> 以上时间窗口为最为理想状况下的测试时间，如果出现意外状况，时间顺延。

| **阶段**       | **任务**                              | **日期**    | **天数** | **负责方**      |
|----------------|---------------------------------------|-------------|----------|-----------------|
| 测试阶段       | 旧生产、新生产的环境调查              | N/A天       | 5天      | 容灾工程师      |
|                | 根据性能状况得出可行方案              | N/A天       | 2天      | 各方            |
|                | 测试可行方案                          | N/A天       | 5天      | 容灾工程师      |
|                | 得出结论和容灾方案                    | N/A天       | 5天      | 容灾工程师      |
|                | 确定实施方案                          | N/A天       | 3天      | 各方            |
|                | **合计**                              | 　          | **20天** | 　              |
| 安装配置       | 实施方案动员,提供正式容灾环境必备条件 | 5.21-5.21   | 3天      | 各方            |
|                | supersync软件调试和配置               | 5.22 - 6.26 | N/A天    | 容灾工程师      |
|                | 目标端表空间配置                      | 5.22 - 6.26 | N/A天    | 　              |
|                | **合计**                              | **　**      | **8天**  | 　              |
| 数据初次初始化 | supersync正常启动复制                 | N/A天       | N/A天    | 容灾工程师      |
|                | 完成数据第一次初始化完成包括校验      | 5.31 – 6.10 | 11天     | 容灾工程师      |
|                | 数据确认及业务连接调试                | N/A天       | N/A天    | 应用开发商      |
|                | **合计**                              | **　**      | **15天** | 　              |
| 　             | **合计**                              | **　**      | **2天**  | 　              |
| 应用测试       | 应用进行性能测试和功能测试            | 6.13 - 6.19 | 7天      | 应用开发商，DBA |
| 　             | **合计**                              | 　          | **7天**  | 　              |
| 系统试运行     | 跟踪解决遗留问题                      | 　          | 　       | 容灾工程师      |
|                | 对复制系统通道、参数、模式进行优化    |             |          | 容灾工程师      |
|                | 系统监控                              |             |          | 容灾工程师      |
|                | 系统运维                              |             |          | 容灾工程师      |
|                | **合计**                              | **　**      | 　       | **　**          |
| 评估总结       | 评估项目实施效果                      | 　          | 　       | 各方            |
|                | 总结项目经验                          |             |          | 各方            |
|                | 提交项目文档                          |             |          | 各方            |
|                | 制定下一阶段方案                      |             |          | 各方            |
|                | **合计**                              | 　          | **2天**  | 　              |
| 演练容灾切换   | 准备容灾切换脚本                      | 7.1 - 7.1   | 1天      | 容灾工程师      |
|                | 正式容灾切换                          | 7.2 - 7.2   | 1天      | 容灾工程师      |
|                | 合计                                  | **　**      | **2天**  | 　              |
| 项目验收       | 签署项目验收报告                      | 7.3-7.4     | **1天**  | 容灾工程师      |

确定分工界面
------------

数据容灾项目实施过程中的责任分工。

以下是整个容灾过程的责任分工。如果容灾过程中需要友商资源支持，应由客户负责协调。

1.  数据容灾分工界面

| **阶段**     | **日期**     | **天数** | **内容**               | **操作步骤**                                                                                                      | **DBA** | **客户/维护代理商** | **容灾小组** |
|--------------|--------------|----------|------------------------|-------------------------------------------------------------------------------------------------------------------|---------|---------------------|--------------|
| 测试准备阶段 | 第1天- 第5天 | 5天      | 环境分析               | 静态表数据变动验证                                                                                                | 协助    | 负责                | 协助         |
|              |              |          |                        | 按静态，动态，临时，中间进行分类                                                                                  |         |                     |              |
|              |              |          |                        | 按优先级分类                                                                                                      |         |                     |              |
|              |              |          |                        | 优先级高的表设立紧急处理方式                                                                                      |         |                     |              |
|              | 第6天-第12天 | 6天      | 容灾切换动员           | 成立容灾切换小组，处理数据库容灾相关事宜                                                                          |         |                     |              |
|              |              |          |                        | 明确容灾切换前后的人员安排及各自任务                                                                              | 负责    | 协助                |              |
|              | 13天-15天    | 2天      | 源端调优               | 1、 源端开启archive log归档,并且应该具备完善的归档备份及删除策略。                                                | 协助    | 负责                |              |
|              |              |          |                        | 2、  源端开启force\_logging参数。                                                                                 |         |                     |              |
|              |              |          |                        | 3、  源端、目标端操作系统层面为hw预留一个500G的文件系统。                                                         |         |                     |              |
|              | 16 天 -18天  | 2天      | 整理用户               | 4、  梳理出所有需要容灾的用户。                                                                                   |         |                     |              |
| 容灾环境准备 | 5.21-5.22    | 2天      | 　                     | 1、  目标端操作系统层面为hw预留一个1000G的文件系统。                                                              | 负责    | 协助                | 协助         |
|              |              |          |                        | 2、  源端、目标端字符集检查                                                                                       |         |                     |              |
|              |              |          |                        | 3、  数据核对，对临时表空间的耗用很大，建议单独dsg用户建了一个500G的临时表空间。                                  |         |                     |              |
|              |              |          |                        | 4\. 目标端性能参数确认                                                                                            |         |                     |              |
|              | 5.23-5.28    | 5天      | 　                     | 5.目标端数据库参数调优                                                                                            |         |                     |              |
|              |              |          |                        | 6、  目标端表空间布局调整                                                                                         |         |                     |              |
|              |              |          | 同步动态数据           | 数据同步容灾                                                                                                      |         |                     |              |
|              |              |          |                        | 数据核对一遍                                                                                                      |         |                     |              |
|              |              |          |                        | 核对索引、创建主键约束、外键约束。                                                                                |         |                     |              |
|              |              |          |                        | 同步新增表、刷新物化视图。                                                                                        |         |                     |              |
|              |              |          |                        | Toad进行全方位对象比对。                                                                                          |         |                     |              |
|              |              |          | 数据泵导入定义         | 导入元定义                                                                                                        |         |                     |              |
|              |              |          | 动态数据对比           | 使用工具对比动态数据                                                                                              |         |                     |              |
|              |              |          | Toad比对定义(对象级别) | alter session set current\_schema=INTERFACE;                                                                      |         |                     |              |
|              |              |          | 修改状态               | 更改相应的数据连接配置!修改Job：alter system set job\_queue\_processes =0; 关闭Trigger触发器 。关闭所有外键的检查 |         |                     |              |
| 模拟容灾切换 | 6.15-6.15    | 1天      | 全面公告！             |                                                                                                                   | 协助    | 负责                | 协助         |
|              |              |          | 修改目标端用户状态     | 锁定所有需要容灾的用户。                                                                                          | 协助    | 协助                | 负责         |
|              |              |          |                        | /dsg/soft/user/lock.sql                                                                                           |         |                     |              |
|              |              |          | 修改目标端状态         | 修改Job：                                                                                                         |         |                     |              |
|              |              |          |                        | alter system set job\_queue\_processes =0;                                                                        |         |                     |              |
|              |              |          |                        | 关闭Trigger触发器                                                                                                 |         |                     |              |
|              |              |          |                        | 关闭所有外键的检查                                                                                                |         |                     |              |
|              |              |          | 　                     | Toad进行全方位对象比对。                                                                                          |         |                     |              |
|              |              |          |                        | 对动态表进行数据核对。                                                                                            |         |                     |              |
|              |              |          |                        | 开启统计信息。                                                                                                    |         |                     |              |
|              |              |          | 修改索引并发度         | 　                                                                                                                | 协助    | 协助                | 负责         |
|              |              |          | Toad三次比对           | 全选各选项。                                                                                                      |         |                     |              |
|              |              |          |                        | 避开序列、外键状态、触发器。                                                                                      |         |                     |              |
|              |              |          | 导入物化视图日志表     | select owner,object\_name from dba\_objects                                                                       |         |                     |              |
|              |              |          | 校验动态数据           | 　                                                                                                                |         |                     |              |
|              |              |          | 修改用户状态           | /dsg/soft/user/unlock.sql                                                                                         |         |                     |              |
|              |              |          | 对象状态核对           | 处理编译报错的对象                                                                                                |         |                     |              |
|              |              |          |                        | 开启Trigger触发器                                                                                                 |         |                     |              |
|              |              |          |                        | 开启所有外键的检查                                                                                                |         |                     |              |
|              |              |          | 创建序列               | 重建序列                                                                                                          |         |                     |              |
|              |              |          | 重新赋权               | 创建序列、核对权限(系统权限、对象权限、序列权限):                                                                 |         |                     |              |
|              |              |          | 开始JOB                | 修改Job：                                                                                                         |         |                     |              |
|              |              |          |                        | alter system set job\_queue\_processes =10;                                                                       |         |                     |              |
|              |              |          | 业务部门正式启用新库   | 业务部门正式启用备库库                                                                                            | 协助    | 负责                | 协助         |
|              |              |          | 同步动态数据           | 数据同步容灾                                                                                                      |         |                     |              |
|              |              |          |                        | 数据核对一遍                                                                                                      |         |                     |              |
|              |              |          |                        | 核对索引、创建主键约束、外键约束。                                                                                |         |                     |              |
|              |              |          |                        | 同步新增表、刷新物化视图。                                                                                        |         |                     |              |
|              |              |          |                        | Toad进行全方位对象比对。                                                                                          |         |                     |              |
|              |              |          | 数据泵导入定义         | 导入元定义                                                                                                        |         |                     |              |
|              |              |          | exp表单调优            | 　                                                                                                                |         |                     |              |
|              |              |          | Toad比对定义(对象级别) | alter session set current\_schema=INTERFACE;                                                                      |         |                     |              |
|              |              |          | 修改状态               | 更改相应的数据连接配置!修改Job：alter system set job\_queue\_processes =0; 关闭Trigger触发器 。关闭所有外键的检查 |         |                     |              |
| 正式容灾切换 | 7.2-7.2      | 2h       | 全面公告！             | 1、停止Oracle所有应用服务和所有外围应用。                                                                         | 协助    | 协助                | 负责         |
|              |              |          | 修改目标段用户状态     | 锁定所有需要容灾的用户。                                                                                          |         |                     |              |
|              |              |          |                        | /hw/soft/user/lock.sql                                                                                            |         |                     |              |
|              |              |          | 修改状态               | 修改Job：                                                                                                         |         |                     |              |
|              |              |          |                        | alter system set job\_queue\_processes =0;                                                                        |         |                     |              |
|              |              |          |                        | 关闭Trigger触发器                                                                                                 |         |                     |              |
|              |              |          |                        | 关闭所有外键的检查                                                                                                |         |                     |              |
|              |              |          | 同步数据               | 同步数据 ，并创建索引。                                                                                           |         |                     |              |
|              |              |          |                        | Toad进行全方位对象比对。                                                                                          |         |                     |              |
|              |              |          |                        | 对动态表进行数据核对。                                                                                            |         |                     |              |
|              |              |          |                        | 开启统计信息。                                                                                                    |         |                     |              |
|              |              |          | 联系用用厂商进行停业务 | 　                                                                                                                | 协助    | 负责                | 协助         |
|              |              |          | 修改索引并发度         | 　                                                                                                                | 协助    | 协助                | 负责         |
|              |              |          | Toad三次比对           | 全选各选项。                                                                                                      |         |                     |              |
|              |              |          |                        | **避开序列、外键状态、触发器。**                                                                                  |         |                     |              |
|              |              |          | 校验数据               | 　                                                                                                                |         |                     |              |
|              |              |          | 修改用户状态           | /hw/soft/user/unlock.sql                                                                                          |         |                     |              |
|              |              |          | 对象状态核对           | 处理编译报错的对象                                                                                                |         |                     |              |
|              |              |          |                        | 开启Trigger触发器                                                                                                 |         |                     |              |
|              |              |          |                        | 开启所有外键的检查                                                                                                |         |                     |              |
|              |              |          | 创建序列               | 重建序列                                                                                                          |         |                     |              |
|              |              |          | 重新赋权               | 创建序列、核对权限(系统权限、对象权限、序列权限):                                                                 |         |                     |              |
|              |              |          | 开始JOB                | 修改Job：                                                                                                         |         |                     |              |
|              |              |          |                        | alter system set job\_queue\_processes =10;                                                                       |         |                     |              |
|              |              |          | 业务部门正式启用备库   | 业务部门正式启用备库                                                                                              | 协助    | 负责                | 协助         |

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

> 以上时间窗口为最为理想状况下的测试时间，如果出现意外状况，时间顺延。

数据库性能测试
--------------

由于新数据库将承载生产业务，对业务割接后的系统性能、响应、稳定性等都有一定的挑战，需要在正式割接前进行新老数据库的性能比对，用以验证新数据库的性能提升。

### 数据库重放

1.  在EM中获取工作量，创建数据库重放

    <img src="media/image18.png" style="width:5.8in;height:4.3in" />

    <img src="media/image19.png" style="width:5.8in;height:4.3in" />

    <img src="media/image20.png" style="width:5.8in;height:4.3in" />

    <img src="media/image21.png" style="width:5.8in;height:4.3in" />

    <img src="media/image22.png" style="width:5.75625in;height:4.32153in" />

    选择数据库重放文件的保存路径对象及重发的记录时间

    <img src="media/image23.png" style="width:5.8in;height:4.3in" />

    <img src="media/image24.png" style="width:5.8in;height:4.3in" />

    <img src="media/image25.png" style="width:5.76042in;height:4.32292in" />

    <img src="media/image26.png" style="width:5.8in;height:4.3in" />

    <img src="media/image27.png" style="width:5.8in;height:4.3in" /><img src="media/image28.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image29.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image30.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image31.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image32.png" style="width:5.8in;height:4.3in" />

    <img src="media/image33.png" style="width:5.8in;height:4.3in" />

    <img src="media/image34.png" style="width:5.8in;height:4.3in" />

    <img src="media/image35.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image36.png" style="width:5.8in;height:4.3in" />

2.  预处理工作量，新系统做好重放的准备

    <img src="media/image37.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image38.png" style="width:5.8in;height:4.3in" />

    <img src="media/image39.png" style="width:5.8in;height:4.3in" />

    <img src="media/image40.png" style="width:5.75625in;height:4.32153in" />

    <img src="media/image41.png" style="width:5.8in;height:4.3in" />

    <img src="media/image42.png" style="width:5.8in;height:4.3in" />

    <img src="media/image43.png" style="width:5.8in;height:4.3in" />

    <img src="media/image44.png" style="width:5.75625in;height:4.32153in" />

3.  新数据库进行数据库重放

    <img src="media/image45.png" style="width:5.75625in;height:4.32153in" />

运行图中的命令，查看需要至少启动的 client 个数

<img src="media/image46.png" style="width:5.75625in;height:4.32153in" />

<img src="media/image47.png" style="width:5.8in;height:4.3in" />

<img src="media/image48.png" style="width:5.8in;height:4.3in" />

<img src="media/image49.png" style="width:5.75625in;height:4.32153in" />

<img src="media/image50.png" style="width:5.8in;height:4.3in" />

<img src="media/image51.png" style="width:5.8in;height:4.3in" />

<img src="media/image52.png" style="width:5.8in;height:4.3in" />

<img src="media/image53.png" style="width:5.75625in;height:4.32153in" />

<img src="media/image54.png" style="width:5.8in;height:4.3in" />

<img src="media/image55.png" style="width:5.8in;height:4.3in" />

<img src="media/image45.png" style="width:5.8in;height:4.3in" />

将图中的mode的值改为 replay ，启动重放客户端。

<img src="media/image56.png" style="width:5.8in;height:4.3in" />

<img src="media/image56.png" style="width:5.8in;height:4.3in" />

<img src="media/image57.png" style="width:5.8in;height:4.3in" />

<img src="media/image58.png" style="width:5.8in;height:4.3in" />

<img src="media/image59.png" style="width:5.75625in;height:4.32153in" />

<img src="media/image60.png" style="width:5.75625in;height:4.32153in" />

<img src="media/image61.png" style="width:5.75625in;height:4.32153in" />

### 执行计划比对

1.  获取常见的应用查询sql语句

2.  在新老数据库中，设置参数 set autot trace exp stat  ，打开执行计划功能

3.  执行对应的sql语句，查看两个数据库的执行计划是否不同

容灾组网图描述
--------------

介绍容灾后的容灾组网图。

### 容灾后组网图

风险分析
========

从技术风险，环境准备风险和工程风险三个方面进行风险分析。

6.1 技术风险分析

介绍在当前方案选型中存在的技术风险。

[6.2 环境准备风险分析](#数据容灾实施和容灾切换总体)

[介绍对于环境准备风险分析。](#数据容灾实施和容灾切换总体)

6.3 实施过程风险分析

介绍实施风险分析。

技术风险分析
------------

本次实施中涉及到的几个技术点包括：

1.  金三环境下的数据库实时跨平台同步

本次项目中需要将多个业务系统的数据实时跨平台(AIX-\>Linux)同步到灾备系统。考虑到金三系统的复杂性，需要确认金三及相关业务系统数据库是否可以运行在Linux环境，以及金三及其他3套核心业务应用所需要的操作系统环境。要求：

1.  确认数据库版本及可用的操作系统平台；

2.  灾备端应用服务器与生产端应用服务器的操作系统保持一致。

<!-- -->

1.  应用复制复杂性

金三业务系统具有复杂的应用结构，为了保证应用复制的准确、可靠和可用，需要协调相应的应用厂商予以配合。

1.  切换演练

本次项目中的切换演练涉及众多系统，如何协调配合完成业务切换，需要在了解应用结构的基础上独立提供单独的灾备切换方案。

1.  库税银操作

库税银操作具有特殊性，建议在切换演练及测试中，不要实施库税银应用操作，不启动应用。同时，为了防止发生误操作，在整个实施及测试过程中，因避免启动库税银应用与银行的连接。

环境准备风险分析
----------------

本次项目中，环境准备方面目前所知，还需要准备：

1.  字符集问题。

> 由于税务各业务系统的数据库字符集各不相同，需要仔细查询源库字符集，而后在灾备库保持同样配置；

1.  数据库服务器分区。

> 由于有4台高端服务器连接共享磁盘阵列，同步共13个数据库，因此，需要将数据库服务器每台分为2个物理分区，共8个物理分区，其中核心征管需要使用2个分区配置为RAC；其他数据库独占或者共享一个分区。数据配置完成后，数据库工程师应提供相应的配置信息表。

1.  操作系统与数据库版本准备。

> 请用户准备相关的Oracle Linux6.2/Red hat Linux 6.4/Windows2003
> 32bit/Windows 2008 64bit等版本，以及相关系统上的Oracle数据库版本备用；

1.  应用服务器虚拟化及划分。

> 在本次实施中，灾备端需要配置的应用服务器超过15套，为了保证应用需求，建议对6台应用服务器配置虚拟化软件；

1.  存储系统准备及配合。

> 由于存储系统并非本次采购项目中的设备，因此，需要协调存储厂商提供技术支持。

1.  应用厂商配合。

> 本项目中涉及应用厂商众多，需要用户协调应用厂商予以配合，包括提供应用配置信息及应用软件部署、测试演练配合等。可以通过远程支持实现。

1.  备份系统准备。

> 为了保证数据安全，防止误操作及其他异常情况发生，请客户以及应用厂商采用可靠的方式进行数据备份，保证系统数据安全。

1.  工作环境准备。

> 在实际项目中，可能到场的工程师(不算客户和应用厂商)较多，希望准备足够的办公座位以及网络接入。

实施过程风险分析
----------------

在项目实施过程中的风险主要包括如下方面：

1.  生产系统异常

在实施过程中，由于安装软件、软件缺陷、人为误操作等导致生产系统异常。为了防止这种情况，需要所有新安装的软件在上线前在测试系统进行测试；在整个实施过程中，严格管理生产系统的登录，限制权限，减少误操作的可能性，坚持数据备份，保证数据不丢失。同时，确认一项基本原则：在出现任何故障情况下，首先保障生产系统稳定和数据不丢失。

1.  新购软硬件在实施过程中出现故障

在实施过程中，如果出现新购软硬件的故障导致系统异常，就会对整个实施造成重大打击(特别是对于实施工期)。为此需要在各厂商提供随时的现场支持、备件准备，以及提供成熟稳定的软件版本。

1.  业务异动导致实施延迟

由于业务需要，如客户有更重要的事情要处理，或者内控检查、新业务上线等各种业务原因科能导致实施延迟，需要预先有所准备。

1.  人员工作安排出现异常导致实施延迟

参与项目的各方工程师出现临时工作变动可能会影响整个项目实施。因此各方应至少安排2名工程师参与或者跟踪项目(如1人实施，1人备用)，防止项目实施异常中断或者延迟。

1.  方案变更导致实施时间延长

如果在测试论证中发现当前确认的方案存在问题，可能需要调整方案，整个项目实施时间就会延长。在出现此类情况下，建议在确保项目质量的情况下进行调整，即项目质量和项目工期相比，优先考虑项目质量。

附件
====

从针对以上实施方案，提出的详细实施步骤和附件文档。

7.1 [配置容灾数据库](#配置容灾数据库)

介绍在怎样详细配置容灾数据库。

[7.2](#数据容灾实施和容灾切换总体)
[SuperSync主端安装配置](#supersync主端安装配置)

介绍在主端上实施安装配置软件。

7.3 [SuperSync备端上安装配置](#supersync备端上安装配置)

介绍在备端上实施安装配置软件。

测试结果说明：

1、“OK” 测试通过，OK后面的括弧中内容表示存在的问题；

2、“ /” 未测试或无需测试；

3、“不通过” 测试不通过。

配置容灾数据库
--------------

介绍数据容灾前如何配置主、备端数据库。

### 配置备端主机和存储

1.  安装主机操作系统，并完成网络配置等。

请根据客户需求及官方网站发布的操作系统安装指南完成操作系统的安装，并配置网卡、HBA卡等。

> <img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

主机名是后续配置ORACLE时，要记录在OCR里的，数据库安装完成后不能修改配置进行更改，必须通过先删除节点再添加节点或重新安装或配置集群的方式修改。建议提前规划以免后续复杂变更。

1.  用存储配套的巡检工具巡检，或者手动巡检。确保没有问题和风险再做下一步操作。

<img src="media/image62.png" style="width:0.9375in;height:0.4375in" alt="注意" />

启动数据容灾前，必须确认目标存储工作状态正常，无任何告警，否则不能进行数据容灾操作。

请根据目标存储产品文档记录的“配置--\>基础存储业务指南”，按照以下要求，完成目标存储的配置。相关目标存储产品文档请到官方网站获取。

-   目标存储规划已由专业人员完成存储网络、可靠性和性能等评估。

-   目标存储规划已与客户协商，并满足客户需求，请参考存储LLD文档完成目标存储配置。

<img src="media/image62.png" style="width:0.9375in;height:0.4375in" alt="注意" />

1\.
当目标存储新创建的LUN的运行状态是“正在格式化”时，可以进行配置操作，但不能进行数据容灾。

2\.
全部LUN的运行状态从“正在格式化”变成“在线”后，表示可正常读写数据，才能再进行数据容灾操作。

1.  目标存储接入主机网络。

建议参考图2-3，将目标存储多链路接入网络。

1.  主机配置多路径软件。

目标存储多链路接入网络，需要在主机端安装目标存储多路径软件，请参照对应的多路径安装指导书。

1.  将目标存储的LUN映射给备端数据库对应的主机。

2.  主机检查识别到新映射的LUN，如果发现识别或磁盘状态不正常，需要重启主机。

----结束

### 确定备端数据库配置

1.  确定备端数据库的版本。

建议备端数据库的版本与源数据库版本一致。

1.  备端数据库存储空间规划。

目标库的SYSTEM/SYSAUX/UNDO/临时表空间的大小，必须要大于等于源库；

目标库的日志文件和每个日志文件组的成员个数必须要大于等于源库；

备端数据库的用户表空间要大于等于源数据库的空间。

1.  确定备端数据库基础参数。

<!-- -->

1.  确定管理员和组。

2.  数据库安装路径。

3.  密码复杂度设置。

4.  网络监听配置。

    1.  确定备端数据库实例相关信息。

数据库实例名称。

数据库文件存储方式。

是否启用闪回和归档功能及其功能参数。

内存管理方式，SGA、PGA等大小。

块大小及数据库连接数。

数据库字符集和国家字符集等。

其他初始化参数。

1.  网络配置信息。

-   客户端配置

\# cat /etc/hosts

\# cat tnsnames

\# tnsnames.ora.hxrac1 Network Configuration File:
/u01/app/oracle/product/10.2.0.5/db\_1/network/admin/tnsnames.ora.hxrac1  
\# Generated by Oracle configuration tools.  
  
EXTPROC\_CONNECTION\_DATA =  
(DESCRIPTION =  
(ADDRESS\_LIST =  
(ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC0))  
)  
(CONNECT\_DATA =  
(SID = PLSExtProc)  
(PRESENTATION = RO)  
)  
)  
  
hxrac =  
(DESCRIPTION =  
(ADDRESS = (PROTOCOL = TCP)(HOST = hxrac1\_vip)(PORT = 1521))  
(ADDRESS = (PROTOCOL = TCP)(HOST = hxrac2\_vip)(PORT = 1521))  
(LOAD\_BALANCE = off)  
(CONNECT\_DATA =  
(SERVER = DEDICATED)  
(SERVICE\_NAME = hexin)  
(FAILOVER\_MODE =  
(TYPE = SELECT)  
(METHOD = BASIC)  
(RETRIES = 180)  
(DELAY = 5)  
)  
)  
)

1.  与客户确认是否有其他特殊配置需要在目标端进行配置。

----结束

### 配置备端数据库

| **类别**     | **具体要求**                                                                                                                                                                  |
|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 软件安装目录 | 空间大小：A\*B/3与C/3(数据库数据量/3)之间的大值，建议文件系统名/dsg。                                                                                                         |
| 操作系统用户 | 建立操作系统用户dsg，该用户：对安装目录/dsg具有完全控制权限，具有oracle用户环境变量，可以访问(读)所有oracle数据库相关文件(oracle软件、数据文件)，加入dba组，可以使用crontab。 |
| /etc/hosts   | 在目标端的/etc/hosts文件中添加上源端的主机IP、主机名。                                                                                                                        |
| /tmp空间     | 不少于1GB。                                                                                                                                                                   |
| 端口开放要求 | 确认本机对外IP地址的6000-7000之间的端口对外开放，可以建立TCP/IP连接；在有防火墙的情况下，确认从源端可以访问本机对外IP地址的6000-7000之间的端口。                              |

### 配置主端数据库

| **类别**     | **具体要求**                                                                                                                                                                  |
|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 软件安装目录 | 空间大小为A\*B/3，即每天日志量\*保留天数/3，建议文件系统名/dsg。                                                                                                              |
| 操作系统用户 | 建立操作系统用户dsg，该用户：对安装目录/dsg具有完全控制权限，具有oracle用户环境变量，可以访问(读)所有oracle数据库相关文件(oracle软件、数据文件)，加入dba组，可以使用crontab。 |
| /etc/hosts   | 在源端的/etc/hosts文件中添加上目标端的主机IP、主机名。                                                                                                                        |
| /tmp空间     | 不少于1GB。                                                                                                                                                                   |
| 数据库日志   | 每个实例的redo不少于5组，每组日志成员个数不限，每个日志文件不少于500MB。                                                                                                      |
| 端口开放要求 | 确认本机对外IP地址的6000-7000之间的端口对外开放，可以建立TCP/IP连接；在有防火墙的情况下，确认从目标端可以访问本机对外IP地址的6000-7000之间的端口。                            |

SuperSync主端安装配置
---------------------

### 主端安装SuperSync容灾软件

### 安装前的准备工作

#### 规划磁盘

软件需要安装后使用，需要一定空间存放缓存文件。

大小为总数据量的15%。目录命名为/dsg.

#### 队列规划

| **数据库** | **IP 地址** | **安装目录** | **同步状态** | **大小** | **表类型** | **动态静态** | **同步表**     | **调整（增加或者删除）** |
|------------|-------------|--------------|--------------|----------|------------|--------------|----------------|--------------------------|
| zhptzjk    | 10.24.89.16 | /dsg/ds1     | 提前同步     | 1T       | LOB        | 静态         | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds2     | 提前同步     | 1T       | LOB        | 静态         | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds3     | 当晚同步     | 1T       | LOB        | 动态         | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds4     | 当晚同步     | 1T       | VARCHAR2   | 动态         | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds5     | 提前同步     | 2T       | VARCHAR2   | 静态         | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds6     | 当晚同步     | 1T       | OTHER TYPE | 动态         | 　详细请见表格 | 　详细请见表格           |

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

> 根据筛选出来的静态表、动态表、静态分区、动态分区来确定同步的同步批次。
>
> 通过校验静态表、动态表、静态分区、动态分区来进行校验。
>
> 队列规划表格为<img src="media/image63.emf" style="width:1.07292in;height:0.73958in" />

#### 队列调优

| **数据库** | **IP 地址** | **安装目录** | **同步状态** | **同步表**     | **调整（增加或者删除）** |
|------------|-------------|--------------|--------------|----------------|--------------------------|
| zhpt1      | 10.24.89.17 | /dsg/ds1     | 提前同步     | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds2     | 提前同步     | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds3     | 当晚同步     | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds4     | 当晚同步     | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds5     | 提前同步     | 　详细请见表格 | 　详细请见表格           |
|            |             | /dsg/ds6     | 当晚同步     | 　详细请见表格 | 　详细请见表格           |

> <img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />队列调优表格为<img src="media/image64.emf" style="width:1.07292in;height:0.73958in" />

#### 端口规划

| **数据库** | **IP 地址** | **安装目录** | **端口号**    | **数据库用户密码** | **操作系统密码** |
|------------|-------------|--------------|---------------|--------------------|------------------|
| zhpt1      | 10.24.89.17 | /dsg/ds1     | 55010 - 55015 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds2     | 55020 - 55025 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds3     | 55030 - 55035 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds4     | 55041 - 55045 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds5     | 55051 - 55055 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds6     | 55060 - 55065 | dsg/dsg            | dsg/dsg          |

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

以上端口是前期规划，防火墙必须开放这些端口。

#### 创建操作系统用户

创建操作系统用户：dsg密码：

> useradd -u 302 -g oinstall -G dba -d /dsg -s /usr/bin/ksh -m dsg
>
> passwd dsg
>
> Z9s7uP

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

> Dsg用户需要所有的oracle grid 的组权限。

#### 创建数据库用户

> create tablespace user\_dsg datafile
> '+FCDISKGROUP2/zhpt/DATAFILE/user\_dsg\_01.dbf' size 1g;
>
> create temporary tablespace temp\_dsg tempfile
> '+FCDISKGROUP2/zhpt/DATAFILE/temp\_dsg\_01.dbf' size 30G;
>
> create user dsg identified by "Z9s7uP" default tablespace user\_dsg
> temporary tablespace temp\_dsg;

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

指定大点的临时表空间会提升数据校验性能。

create user dsg identified by dsg default tablespace users temporary
tablespace temp;

#### 数据库权限

> grant select any table,select any dictionary,alter system
> ,exp\_full\_database,connect to dsg; 
>
>  

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

最好赋予dba allpriviliges 权限给DSG (源端目标端)。

grant dba,all privileges to dsg;;

#### 安装目录规划

> mkdir /dsg/ds1
>
> mkdir /dsg/ds2
>
> mkdir /dsg/ds3
>
> mkdir /dsg/ds4
>
> mkdir /dsg/ds5
>
> . . . . . . .. . .
>
> .. . . . . . . .
>
> . . . . .

#### 创建视图

> create or replace view DBPS\_XKCCLE as select \* from sys.x$kccle;
>
> create or replace view DBPS\_XKCCLH as select \* from sys.x$kcclh;
>
> create or replace view DBPS\_XKCCCF as select \* from sys.x$kcccf;
>
> create or replace view DBPS\_XKCCCP as select \* from sys.x$kcccp;
>
> create or replace view DBPS\_XKCCDI as select \* from sys.x$kccdi;
>
> create or replace view DBPS\_XKCRMF as select \* from sys.x$kcrmf;
>
> create or replace view DBPS\_XKTUXE as select \* from sys.x$ktuxe;
>
> create or replace view DBPS\_XLE as select \* from sys.x$le;
>
> create or replace view DBPS\_XBH as select \* from sys.x$bh;
>
> create or replace view DBPS\_XKTFBFE
>
> as
>
> select fi.file\#,f.block\#,f.length from sys.fet$ f,sys.file$ fi
>
> where f.ts\# = fi.ts\# and f.file\# = fi.relfile\#
>
> union all
>
> select fi.file\#,f.KTFBFEFNO,f.ktfbfeblks from sys.x$ktfbfe
> f,sys.file$ fi
>
> where f.ktfbfetsn=fi.ts\# and f.KTFBFEFNO = fi.relfile\#;

#### 配置操作系统DSG的环境变量

> ORACLE\_BASE=/u01/app/oracle
>
> ORA\_DB=/u01/app/oracle/product/10.2.0/db\_1/dbs
>
> ORACLE\_SID=zhptzjk3
>
> ORA\_NLS33=/u01/app/oracle/product/10.2.0/db\_1/ocommon/nls/admin/data
>
> ORA\_CRS\_HOME=/u01/app/oracle/product/10.2.0/crs
>
> ORACLE\_HOME=/u01/app/oracle/product/10.2.0/db\_1
>
> ALERT\_ORA=/u01/app/oracle/admin/zhptzjk/bdump/alert\_zhptzjk3.log

### 登陆系统主机

以dsg用户登陆

### 安装SuperSync软件

> 拷贝提供的SuperSync\_setup.\*.zip软件到相应的安装目录，利用提供的安装脚本执行setup.sh进行SuperSync安装(此步骤只是创建好目录和相应脚本)：
>
> sh setup.sh

### 启动Agent和Dbpsd

1.  对容灾进行启动、查看、停止脚本

$cd /supersync/scripts

> $./start(启动脚本)
>
> $./check(查看脚本)
>
> $./stop(停止脚本)

### 查看SuperSync进程日志

> 查看容灾的启动日志
>
> $cd /supersync /log
>
> $vi log.dbpsd
>
> DBPS running on GS1 (Listening any:50000)
>
> 以上显示为正确启动
>
> $vi log.vagentd
>
> Data Capture service enabled
>
> Performance report is disabled
>
> Detail Performance report is disabled
>
> 以上显示为正确启动
>
> --源端安装结束

SuperSync备端上安装配置
-----------------------

### 安装前的准备工作

1.  安装操作系统;

2.  安装数据库;

3.  调整数据库;

> 数据文件、表空间要和生产库保持一致数量和大小;

#### 规划磁盘

软件需要安装后使用，需要一定空间存放缓存文件。

大小为总数据量的15% 。目录命名为/dsg.

#### 端口规划

| **数据库** | **IP 地址** | **安装目录** | **端口号**    | **数据库用户密码** | **操作系统密码** |
|------------|-------------|--------------|---------------|--------------------|------------------|
| zhptzjk    | 10.24.89.16 | /dsg/ds1     | 55010 - 55015 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds2     | 55020 - 55025 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds3     | 55030 - 55035 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds4     | 55041 - 55045 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds5     | 55051 - 55055 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds6     | 55060 - 55065 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds7     | 55070 - 55075 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds8     | 55080 - 55085 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds9     | 55091 - 55095 | dsg/dsg            | dsg/dsg          |
|            |             | /dsg/ds10    | 55101 - 55105 | dsg/dsg            | dsg/dsg          |

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

> 生产库和目标库软件端口必须保持一致，以便单队列进行修复数据。

#### 创建操作系统用户

> user add dsg -d /dsg -g oinstall -G dba
>
> passwd dsg

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

> Dsg用户需要所有的oracle grid 的组权限。

#### 创建数据库用户

创建dsg ORACLE 数据库用户

> 创建数据库用户
>
> create user c\#\#dsg identified by dsg default tablespace users
> container=all;
>
> ;

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

指定大点的临时表空间会提升数据校验性能。

create user dsg identified by dsg default tablespace users temporary
tablespace temp;

#### 数据库权限

> grant dba,select on sys.user$ to c\#\#dsg container=all

<img src="media/image16.png" style="width:0.5in;height:0.16667in" alt="说明" />

最好赋予dba allpriviliges 权限给DSG (源端、目标端)。

grant dba,all privileges to dsg;;

 

#### 安装目录规划

> mkdir /dsg/dt1
>
> mkdir /dsg/dt2
>
> mkdir /dsg/dt3
>
> mkdir /dsg/dt4
>
> mkdir /dsg/dt5
>
> . . . . . . .. . .
>
> .. . . . . . . .

#### 创建视图

> CDB创建视图
>
> create or replace view DBPS\_XKCCLE as select \* from sys.x$kccle;
>
> create or replace view DBPS\_XKCCLH as select \* from sys.x$kcclh;
>
> create or replace view DBPS\_XKCCCF as select \* from sys.x$kcccf;
>
> create or replace view DBPS\_XKCCCP as select \* from sys.x$kcccp;
>
> create or replace view DBPS\_XKCCDI as select \* from sys.x$kccdi;
>
> create or replace view DBPS\_XKCRMF as select \* from sys.x$kcrmf;
>
> create or replace view DBPS\_XKTUXE as select \* from sys.x$ktuxe;
>
> create or replace view DBPS\_XLE as select \* from sys.x$le;
>
> create or replace view DBPS\_XBH as select \* from sys.x$bh;
>
> create or replace view DBPS\_XKTFBFE
>
> as
>
> select fi.file\#,f.block\#,f.length from sys.fet$ f,sys.file$ fi
>
> where f.ts\# = fi.ts\# and f.file\# = fi.relfile\#
>
> union all
>
> select fi.file\#,f.KTFBFEFNO,f.ktfbfeblks from sys.x$ktfbfe
> f,sys.file$ fi
>
> where f.ktfbfetsn=fi.ts\# and f.KTFBFEFNO = fi.relfile\#;
>
> PDB 创建视图
>
> create or replace view DBPS\_XKCCCP as select \* from sys.x$kcccp;
>
> create or replace view DBPS\_XKCCLE as select \* from sys.x$kccle;

#### 配置操作系统DSG的环境变量

> ORACLE\_BASE=/u01/app/oracle
>
> ORA\_DB=/u01/app/oracle/product/10.2.0/db\_1/dbs
>
> ORACLE\_SID=zhptzjk3
>
> ORA\_NLS33=/u01/app/oracle/product/10.2.0/db\_1/ocommon/nls/admin/data
>
> ORA\_CRS\_HOME=/u01/app/oracle/product/10.2.0/crs
>
> ORACLE\_HOME=/u01/app/oracle/product/10.2.0/db\_1
>
> ALERT\_ORA=/u01/app/oracle/admin/zhptzjk/bdump/alert\_zhptzjk3.log

### 登陆系统主机 

以dsg用户登陆

### 安装SuperSync软件

拷贝提供的SuperSync\_setup.\*.zip软件到相应的安装目录，利用提供的安装脚本执行setup.sh进行SuperSync安装：

> sh setup.sh

### 配置DSG用户的环境变量。

> export PATH
>
> export ORACLE\_BASE=/u01/app/oracle
>
> export ORACLE\_HOME=$ORACLE\_BASE/product/11.2.0/dbhome\_2
>
> export ORACLE\_SID=OADB
>
> export PATH=$PATH:$ORACLE\_HOME/bin
>
> export LANG=C
>
> export
> LD\_LIBRARY\_PATH=/dsg/elib:/u01/app/oracle/product/11.2.0/dbhome\_2/lib;export
> LD\_LIBRARY\_PATH
>
> alias ss='sqlplus dsg/Z9s7:\\\>uP'
>
> export PS1="\[$LOGNAME@\`uname -n\`:$ORACLE\_SID:\\$PWD\]\#"

### 启动Agent

> 对复目标端制进行启动、查看、停止脚本
>
> $cd /supersync /scripts
>
> $./start(启动脚本)
>
> $./check(查看脚本)
>
> $./stop(停止脚本)

**注：作为目标库不用容灾主机上注册主机、数据库，而只需要启动vagentd进程。**

### 查看SuperSync进程日志

> 查看容灾的启动日志
>
> $cd /supersync/log
>
> $vi log.vagentd
>
> Data Capture services started
>
> PSM services started
>
> 以上显示为正确启动
>
> $vi log.vagentd
>
> IPC\_KEY=0x63000809
>
> DBPS agent running on 44P270 (Listening any:6601)
>
> DBIInit multi-dedicated mode
>
> Data Capture service enabled
>
> 以上显示为正确启动
