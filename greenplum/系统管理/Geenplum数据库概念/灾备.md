---
title: 灾备
description: 灾备
published: true
date: 2021-08-23T03:45:09.794Z
tags: 灾备
editor: markdown
dateCreated: 2020-08-23T06:45:19.203Z
---


本主题提供了对Greenplum数据库高可用性特性的高级概述。通过镜像组件，可以部署Greenplum数据库，而不会出现单点故障。下面几节将描述镜像Greenplum系统的主要组件的策略。有关Greenplum高可用性特性的更详细概述，请参见[Greenplum数据库高可用性概述]()。

> 重要提示:当Greenplum数据库集群不能接受数据丢失时，建议使用Greenplum怕primary镜像和段镜像。如果没有启用镜像，那么Greenplum只存储数据的一个副本，因此底层存储媒体提供了在硬件故障时数据可用性和正确性的唯一保证。

# 关于镜像段

在部署Greenplum数据库系统时，可以配置镜像段实例。镜像段允许数据库查询在主段不可用时故障转移到镜像段。通过事务日志复制过程保持镜像段的最新状态，事务日志复制过程同步主实例和镜像实例之间的数据。强烈建议在生产系统中使用镜像。


作为一种最佳实践，辅助(镜像)段实例必须始终驻留在与其主段实例不同的主机上，以防止单一主机故障。在虚拟化环境中，辅助(镜像)段必须始终驻留在与主段不同的存储系统上。镜像段可以按照设计为最大化可用性或最小化主机或多个主段故障时的性能下降的配置在集群中剩余的主机上进行安排。

当您初始化或展开Greenplum系统时，有两种标准的镜像配置可用。默认配置称为组镜像，它将一台主机的主段的所有镜像放在集群中的另一台主机上。另一个标准配置是扩展镜像，可以通过命令行选项来选择。扩散镜像将每个主机的镜像分散到其余主机上，并要求集群中的主机数量超过每个主机的主段数量。

图1显示了在配置扩展镜像时表数据如何跨段分布。

![group-mirroring.png](/greenplum/group-mirroring.png)

# 段故障转移和恢复

当在Greenplum数据库系统中启用了段镜像时，如果主段实例不可用，系统将自动故障转移到镜像段实例。如果一个段实例或主机宕机，只要剩余活动段实例上的所有数据可用，Greenplum数据库系统就可以继续运行。

如果master不能连接到一个段实例，它将该段实例标记为Greenplum数据库系统目录中的下端，并在相应的位置打开镜像段。失败的段实例将一直处于不操作状态，直到管理员采取步骤使该段恢复联机状态。管理员可以在系统启动和运行时恢复失败的段。恢复过程只复制在段停止运行时丢失的更改。

如果您没有启用镜像，系统将在一个段实例失效时自动关闭。在继续操作之前，必须恢复所有失败的段。


# 关于master节点冗余

您还可以选择在与master主机不同的主机上部署主实例的备份或镜像。当master主机无法运行时，standby主机实例(standby主主机)充当热备用。通过事务日志复制过程保持standby主服务器的最新状态，事务日志复制过程在master服务器和standby主服务器之间同步数据。

如果master主服务器发生故障，日志复制过程将停止，standby主服务器将被激活。切换不会自动发生，但必须从外部触发。在激活standby主服务器时，复制的日志将用于重建主服务器在上次成功提交事务时的状态。激活的standby主服务器有效地成为Greenplum数据库master服务器，在master端口(在master主机和standby主主机上必须设置相同的端口号)上接受客户端连接。

由于master 系统表不包含任何用户数据，所以只需要在master和standby之间同步系统编目表。当更新这些表时，更改将自动复制到备用主服务器，以确保与主服务器同步。

图2。在Greenplum数据库中的主镜像

![standby_master.jpg](/greenplum/standby_master.jpg)

# 网卡冗余

互连指的是各段和此通信所依赖的网络基础设施之间的进程间通信。通过在网络上部署双千兆以太网交换机和到Greenplum数据库主机(主服务器和段服务器)的冗余千兆连接，可以实现高可用性互连。出于性能考虑，建议使用10 gb或更快的以太网。