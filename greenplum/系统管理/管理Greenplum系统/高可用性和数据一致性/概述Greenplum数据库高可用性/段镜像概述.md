---
title: 段镜像概述
description: 段镜像概述
published: true
date: 2021-08-23T03:47:39.320Z
tags: 段镜像概述
editor: markdown
dateCreated: 2020-08-25T13:54:59.060Z
---

# 段镜像概述
当Greenplum数据库高可用性被启用时，有两种类型的段实例:主段和镜像段。每个主段有一个相应的镜像段。主段实例接收来自主段的更改请求，然后将这些更改复制到相应的镜像。如果Greenplum数据库检测到一个主段失败或变得不可用，它将其镜像段的角色更改为主段，将不可用的主段的角色更改为镜像段。

发生故障时，正在进行的事务将回滚并必须重新启动。然后，管理员必须恢复镜像段，允许镜像与当前主段同步，然后交换主段和镜像段，使它们处于各自的首选角色。


如果没有启用段镜像，那么如果一个段实例失败，Greenplum数据库系统将关闭。在恢复Greenplum数据库操作之前，管理员必须手动恢复所有失败的段。

当对现有系统启用了段镜像时，主段实例继续向用户提供服务，同时获取主段的快照。在获取并部署镜像段实例上的快照时，还会记录对主段的更改。在镜像段上部署快照之后，将同步镜像段，并使用基于Write-Ahead Logging (WAL)的流复制保持当前状态。

Greenplum数据库WAL复制使用walsender和walreceiver复制过程。walsender进程是一个主段进程。walreceiver是一个镜像段进程。

当发生数据库更改时，捕获更改的日志将流到镜像段，以使其与相应的主段保持同步。在WAL复制期间，数据库更改将在应用之前写入日志，以确保任何进程内操作的数据完整性。

当Greenplum Database检测到主段故障时，WAL复制过程停止，镜像段自动作为活动主段启动。如果镜像段在主镜像处于活动状态时发生故障或变得不可访问，主镜像段将跟踪在恢复镜像时应用到镜像的日志中的数据库更改。有关段故障检测和恢复过程的信息，请参见[检测故障段]()。

这些Greenplum数据库系统目录表包含镜像和复制信息。

- 数据字典[gp_segment_configuration]()包含主段实例和镜像段实例、主段实例和备用主段实例的当前配置和状态。
- 目录视图[gp_stat_replication]()包含用于Greenplum数据库主镜像和段镜像的`walsender`进程的复制统计信息。

# 关于段镜像配置

镜像段实例可以以不同的配置放置在集群中的主机上。作为一种最佳实践，主段和相应的镜像放置在不同的主机上。每个主机必须具有相同数量的主段和镜像段。当您使用Greenplum数据库实用程序[gpinitsystem]()或[gpaddmirrors]()创建段镜像时，您可以指定段镜像配置、组镜像(默认)或扩展镜像.


在系统初始化期间启用镜像时，组镜像是默认的镜像配置。每个主机的主段的镜像段放在另一个主机上。如果单个主机失败，在支持该失败主机的主机上，活动主段的数量将增加一倍。图1演示了一个组镜像配置。


**图1所示。Greenplum数据库中的组段镜像**
![group-mirroring.png](/greenplum/group-mirroring.png)
扩展镜像可以在系统初始化期间指定。这种配置将每个主机的镜像分散到多个主机上，这样，如果任何一台主机出现故障，其他主机都不会将多个镜像提升到活动主段。只有当主机数量大于每台主机的段数时，才可能使用扩展镜像。图2演示了扩展段镜像配置中镜像的位置。
**图2。Greenplum数据库中的扩展段镜像**
![spread-mirroring.png](/greenplum/spread-mirroring.png)
注意:在创建系统或扩展系统时，必须确保有适当数量的主机系统用于镜像配置。例如，要创建一个配置了扩展镜像的系统，需要的主机数量要多于每个主机的段实例数量，而配置了组镜像的系统在扩展系统时至少需要两个新主机。有关段镜像配置的信息，请参见段镜像配置。有关启用段镜像扩展系统的信息，请参见规划镜像段。