---
title: 概述Greenplum数据库高可用性
description: 概述Greenplum数据库高可用性
published: true
date: 2021-08-23T03:47:26.476Z
tags: 概述greenplum数据库高可用性
editor: markdown
dateCreated: 2020-08-24T16:26:44.616Z
---

# 概述Greenplum数据库高可用性
通过提供容错硬件平台、启用Greenplum数据库高可用性特性、执行定期监控和维护程序以确保所有系统组件的健康，可以使Greenplum数据库系统具有高可用性。

无论是由于正常磨损还是意外情况，硬件组件最终都会失效。断电会导致组件暂时不可用。通过为可能发生故障的组件提供冗余备用，可以使系统具有高可用性，以便在发生故障时服务可以不间断地继续运行。在某些情况下，冗余的成本高于用户对服务中断的容忍度。在这种情况下，目标是确保能够恢复全部服务，并且能够在预期的时间范围内恢复。

使用以下方案，实现了容错和数据可用性:

## 硬件级RAID

Greenplum数据库部署的一个最佳实践是使用硬件级RAID为单个磁盘故障提供高性能冗余，而不必进行数据库级容错。这在磁盘级别上提供了较低的冗余级别。

## 数据存储校验和

Greenplum数据库使用校验和来验证从磁盘加载到内存的数据在文件系统上没有被损坏。

Greenplum数据库有两种用于用户数据的存储方式:堆优化和附加优化。这两种存储模型都使用校验和来验证从文件系统读取的数据，并且在默认设置下，它们以类似的方式处理校验和验证错误。

Greenplum数据库主进程和段数据库进程在它们管理的内存中更新页面上的数据。当内存页被更新并刷新到磁盘时，校验和将与该页一起计算并保存。当稍后从磁盘检索页面时，将验证校验和，并且仅当验证成功时才允许该页面进入托管内存。校验和验证失败表明文件系统中存在损坏，并导致Greenplum数据库生成错误，导致事务中止。

默认的校验和设置提供了最好的保护，防止未检测到的磁盘损坏传播到数据库和镜像段。

当使用gpinitsystem管理工具初始化Greenplum数据库集群时，默认情况下启用堆校验和支持。可以通过在gpinitsystem集群配置文件中将HEAP_CHECKSUM参数设置为off来初始化不支持堆校验和的集群。看到gpinitsystem,尽管强烈反对这样做.

一旦初始化，就不可能在不重新初始化系统和重新加载数据库的情况下更改集群的堆校验和支持。

您可以检查只读服务器配置参数`data_checksum`来查看集群中是否启用了堆校验和:

```
$ gpconfig -s data_checksums
```

当Greenplum数据库集群启动时，gpstart实用程序将检查堆校验和在主服务器和所有段上是否一致启用或禁用。如果有任何错误，集群将无法启动。请参见[gpstart]()。

在有必要的情况下忽略堆校验和验证错误提示,这样可以恢复数据,设置`ignore_checksum_failure`系统配置参数导致Greenplum数据库发出警告当一堆校验和验证失败,但是页面允许加载到内存管理。如果页面被更新并保存到磁盘，则损坏的数据可以复制到镜像段。因为这可能导致数据丢失，所以应该只在启用数据恢复时将`ignore_checksum_failure`设置为on。

对于添加优化的存储，校验和支持是在使用CREATE table命令创建添加优化的表时设置的几个存储选项之一。默认存储选项是在`gp_default_storage_options`服务器配置参数中指定的。默认情况下启用校验和存储选项，强烈建议不要禁用该选项。

如果您选择禁用附加优化表的校验和，那么您也可以禁用.


- 在创建表之前，将`gp_default_storage_options`配置参数更改为包含`checksum=false`，或者
- 将`checksum=false`选项添加到`CREATE TABLE`语句的`WITH storage_options`子句中。


> 注意，CREATE TABLE语句允许您为各个分区文件设置存储选项，包括校验。

有关语法和示例，请参阅[CREATE TABLE]()命令引用和[gp_default_storage_options]()配置参数引用。

## 段镜像

Greenplum数据库将数据存储在多个段实例中，每个段实例都是一个Greenplum数据库PostgreSQL实例。每个表的数据根据在创建表时DDL中为表定义的分布策略在段之间分布。当启用段镜像时，每个段实例都有一对主镜像和镜像。使用基于写前日志(WAL)的流复制，镜像段与主段保持同步。参见[段镜像概述](/zh/greenplum/系统管理/管理Greenplum系统/高可用性和数据一致性/概述Greenplum数据库高可用性/段镜像概述)。	

每个段的镜像实例通常使用`gpinitsystem`实用程序或`gpexpand`实用程序进行初始化。作为一项最佳实践，镜像运行在与主实例不同的主机上，以防止单机故障。为主机分配镜像有不同的策略。在选择基片和镜像的布局时，重要的是要考虑故障场景，以确保在单机故障的情况下最小化处理倾斜。

## master 镜像

在高可用性集群中有两个主实例，一个主实例和一个备用实例。与段一样，主服务器和备用服务器应该部署在不同的主机上，以便集群能够容忍单个主机的故障。客户端连接到主主服务器，只能在主服务器上执行查询。使用基于写前日志(WAL)的流复制，备用主服务器与主服务器保持同步。参见[master镜像概述](/zh/greenplum/系统管理/管理Greenplum系统/高可用性和数据一致性/概述Greenplum数据库高可用性/master镜像概述).

如果主服务器失败，管理员将运行`gpactivatestandby`实用程序，让备用主服务器作为新的主服务器接管。您可以为主服务器和备用服务器配置虚拟IP地址，这样当当前主服务器发生更改时，客户机程序不必切换到不同的网络地址。如果主主机出现故障，可以将虚拟IP地址交换给实际的代理主机。

## 双重集群

通过维护两个Greenplum数据库集群(都存储相同的数据)，可以提供额外级别的冗余。

在双集群上保持数据同步的两种方法是“dual ETL”和“backup/restore”。

`Dual ETL`提供了一个完整的备用集群，它具有与主集群相同的数据。ETL(提取、转换和加载)指的是清理、转换、验证传入数据并将其加载到数据仓库的过程。使用`dual ETL`，这个过程将并行执行两次，在每个集群上执行一次，并且每次都进行验证。它还允许在两个集群上查询数据，从而使查询吞吐量翻番。应用程序可以利用这两个集群，并确保`ETL`在两个集群上都是成功的和有效的。

要使用备份/恢复方法维护双集群，请创建主集群的备份并在辅助集群上恢复它们。与双ETL策略相比，此方法在辅助集群上同步数据的时间更长，但需要开发的应用程序逻辑更少。在每天或较少执行数据修改和ETL的情况下，使用备份填充第二个集群是理想的。

## 备份与还原

建议定期备份数据库，除非数据库可以从源数据轻松地重新生成。应该采取备份以防止操作、软件和硬件错误。

使用`gpbackup`实用程序备份`Greenplum`数据库。`gpbackup`跨段并行执行备份，因此备份性能随着硬件添加到集群而提高。

在设计备份策略时，首要考虑的是在何处存储备份数据。每个段管理的数据可以备份到段的本地存储上，但不应该永久存储在那里——备份会减少段可用的磁盘空间，更重要的是，硬件故障可能会同时破坏段的实时数据和备份。执行备份之后，应该将备份文件从主集群移到单独的、安全的存储区。或者，可以直接在单独的存储上进行备份。

使用带有`gpbackup`和`gprestore`实用程序的`Greenplum`数据库存储插件，您可以向远程位置或存储设备发送备份，也可以从远程位置或存储设备检索备份。Greenplum数据库存储插件支持连接到位置，包括Amazon Simple storage Service (Amazon S3)位置和Dell EMC数据域存储设备。

使用备份/恢复存储插件API，您可以创建一个自定义插件，`gpbackup`和`gprestore`实用程序可以使用它来将自定义备份存储系统与Greenplum数据库集成。

有关使用gpbackup和gprestore的信息，请参阅[使用gpbackup和gprestore进行并行备份]()。


- [段镜像概述](/zh/greenplum/系统管理/管理Greenplum系统/高可用性和数据一致性/概述Greenplum数据库高可用性/段镜像概述)
- [master镜像概述](/zh/greenplum/系统管理/管理Greenplum系统/高可用性和数据一致性/概述Greenplum数据库高可用性/master镜像概述)


