---
title: 初始化新段主机
description: 初始化新段主机
published: true
date: 2021-08-23T03:59:05.477Z
tags: 初始化新段主机
editor: markdown
dateCreated: 2021-01-13T14:57:52.121Z
---

# 初始化新段
使用gpexpand实用程序创建和初始化新的段实例，并创建扩展模式。

第一次使用有效的输入文件运行`gpexpand`时，它创建并初始化段实例并创建扩展模式。完成这些步骤后，运行gpexpand检测扩展模式是否已经创建，如果已经创建，则执行表重新分配。


- 创建用于系统扩展的输入文件
- 运行gpexpand来初始化新的段
- 回滚失败的扩展设置

# 创建用于系统扩展的输入文件
要开始展开，`gpexpand`需要一个包含新段和主机信息的输入文件。如果您在不指定输入文件的情况下运行`gpexpand`，该实用程序将显示一个交互式访谈，该访谈收集所需的信息并自动创建一个输入文件。

如果您使用交互式面试创建输入文件，您可以在面试提示符中指定一个带有扩展主机列表的文件。如果您的平台或命令`shell`限制主机列表的长度，使用-f指定主机可能是强制性的。

## 以交互模式创建输入文件
在您运行gpexpand以交互模式创建输入文件之前，请确保您知道:
- 新主机的数量(或一个主机文件)
- 新的主机名(或一个主机文件)
- 现有主机(如有)所使用的镜像策略
- 每台主机需要添加的段数(如有)
该实用程序根据这些信息、dbid、内容ID和存储在gp_segment_configuration中的数据目录值自动生成一个输入文件，并将该文件保存在当前目录中。

### 以交互模式创建输入文件

1. 以运行您的Greenplum数据库系统的用户登录主主机;例如,gpadmin。

2. gpexpand运行。该实用程序显示关于如何准备展开操作的消息，并提示您退出或继续。
   还可以使用-f指定一个主机文件。例如:
```bash
$ gpexpand -f /home/gpadmin/new_hosts_file
```
3. 在提示符处，选择Y继续。

4. 除非使用-f指定主机文件，否则系统会提示您输入主机名。扩容主机的主机名以逗号分隔。不要包含接口主机名。例如:
```bash
> sdw4, sdw5, sdw6, sdw7
```
5. 输入系统中使用的镜像策略(如果有的话)。选项是传播| |分组。默认设置是分组的。确保为所选的分组策略拥有足够的主机。有关镜像的更多信息，请参见规划镜像段。

6. 如果有需要添加的主段，请输入新增的主段数量。缺省情况下，新主机初始化的主段数与已有主机相同。通过输入一个大于0的数字来增加每台主机的段。您输入的数字将是在所有主机上初始化的额外段的数量。例如，如果现有的主机目前每个都有两个段，输入值2将在现有主机上初始化两个段，在新主机上初始化四个段。

7. 如果添加新的主段，请为新段输入新的主数据目录根。不要指定实际的数据目录名，它是由gpexpand根据现有的数据目录名自动创建的。
例如，您现有的数据目录如下:

```bash
/gpdata/primary/gp0
/gpdata/primary/gp1
```


然后输入以下命令(在每个提示符处输入)，为两个新的主段指定数据目录:

```bash
/gpdata/primary
/gpdata/primary
```
当初始化运行时，实用程序在`/gpdata/primary`下创建新的目录gp2和gp3。

如果添加新的镜像段，请输入新的镜像数据目录根。不指定数据目录名;它是由gpexpand根据现有的数据目录名自动创建的。
例如，您现有的数据目录如下

```bash
/gpdata/mirror/gp0
/gpdata/mirror/gp1
```
输入以下命令(在每个提示符处输入一个)，为两个新的镜像段指定数据目录:

```bash
/gpdata/mirror
/gpdata/mirror
```
当初始化运行时，实用程序将在/gpdata/mirror下创建新的目录gp2和gp3。
这些用于新分段的主根目录和镜像根目录必须在主机上存在，运行gpexpand的用户必须具有在其中创建目录的权限。
输入了所有必需的信息之后，该实用程序生成一个输入文件并将其保存在当前目录中。例如:

```bash
gpexpand_inputfile_yyyymmdd_145134
```
# 扩展输入文件格式
使用互动面试程序来创建你自己的输入文件，除非你的扩展场景有非典型的需要。

扩展输入文件的格式是:
```bash
hostname|address|port|datadir|dbid|content|preferred_role
```
例子:
```bash
sdw5|sdw5-1|50011|/gpdata/primary/gp9|11|9|p
sdw5|sdw5-2|50012|/gpdata/primary/gp10|12|10|p
sdw5|sdw5-2|60011|/gpdata/mirror/gp9|13|9|m
sdw5|sdw5-1|60012|/gpdata/mirror/gp10|14|10|m
```

对于每个新的段，这种格式的扩展输入文件需要:

|       参数       |              合法值               |                                                                                                        描述                                                                                                        |
| ---------------- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| hostname         | 主机名                            | Segment主机的主机名。                                                                                                                                                                                               |
| port             | 一个可用的端口号                   | Segment的数据库监听器端口，在现有Segment的*port*基数上增加。                                                                                                                                                          |
| fselocation      | 目录名                            | 一个Segment的数据目录（文件空间）位置，这对应着pg\_filespace\_entry系统目录中有关该Segment的记录。                                                                                                                      |
| dbid             | 整数。不能与现有的*dbid*值冲突。    | 用于该Segment的数据库ID。用户输入的值应该是从系统目录gp\_segment\_configuration中显示的现有*dbid*值开始顺序增加的值。例如，要在一个现有10个Segment的阵列（*dbid* 值从1-10）中增加四个节点，应列出新的*dbid*值11、12、13和14。 |
| content          | 整数。不能和现有的*content*值冲突。 | Segment的内容ID。一个主要Segment和它的镜像应该具有相同的内容ID，并且从现有的值开始顺序增加。更多信息请见gp\_segment\_configuration的参考信息中的*content*。                                                                |
| preferred_role   | p                                 | m                                                                                                                                                                                                                  |
| replication_port | 一个可用的端口号                   | 用于该Segment的文件复制端口，在现有Segment的*replication_port*基数上增加。                                                                                                                                            |



# 运行gpexpand初始化新Segment
在用户创建了一个输入文件之后，运行gpexpand以初始化新的Segment。当处理结束时，该工具自动停止Greenplum数据库Segment初始化并且重启系统。

## 要用一个输入文件运行gpexpand

1. 以将要运行用户的Greenplum数据库系统的用户（例如gpadmin）登入Master主机。


2. 运行gpexpand工具，用-i指定输入文件。可以选择使用-D指定在哪个数据库中创建扩展方案。例如：

```bash
$ gpexpand -i input_file
```


该实用程序检测Greenplum数据库系统是否存在扩展模式。如果存在gpexpand模式，则在开始新的展开操作之前使用gpexpand -c删除它。请参见删除展开架构。


当初始化新的段并创建扩展模式时，实用程序打印一条成功消息并退出。


初始化过程完成后，您可以连接到Greenplum数据库并查看扩展模式。gpexpand模式驻留在postgres数据库中。有关更多信息，请参见有关扩展架构。

段初始化完成后，重新分配表，以便在新的段上平衡现有数据。

# 监控集群扩容状态

在任何时候，你都可以通过运行带-x标志的gpstate工具来检查集群扩展的状态:

```bash
$ gpstate -x
```
如果postgres数据库中存在扩容用户，则`gpstate -x`会报告扩容进度。在第一个扩展阶段，gpstate报告新段初始化的进度。在第二阶段，gpstate报告表重新分配的进度，以及重新分配是暂停还是活动的。

# 回滚失败的扩展设置
扩容安装操作(添加段实例和段主机)失败后，才可以进行回滚操作。

如果在初始化过程中扩容失败，而数据库处于down状态，必须先在`master-only`模式下运行`gpstart -m`命令重新启动数据库。

使用以下命令回滚失败的扩容:

```bash
gpexpand --rollback
```


